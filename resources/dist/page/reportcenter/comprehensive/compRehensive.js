function resetTab(){var tab=document.getElementById("dataTable"),columnLength=tab.rows[0].cells.length;for(var i=0;i<tab.rows.length;i++)for(var len=2;len<tab.rows[i].cells.length;len++)tab.rows[i].cells[len].style.display=""}function DeleteSignColumn(col){var tab=document.getElementById("dataTable"),columnLength=tab.rows[0].cells.length;for(var i=0;i<tab.rows.length;i++){for(var len=2;len<tab.rows[i].cells.length;len++)tab.rows[i].cells[len].style.display="none";for(var len=0;len<col.length;len++)tab.rows[i].cells[col[len]].style.display=""}}function execute(a,b){return b==0?"-":(a*100/b).toFixed(2)+"%"}function loadtable(datas,v1,v2){var tab=document.getElementById("dataTable"),columnLength=tab.rows[0].cells.length;for(var i=1;i<tab.rows.length;i++)for(var len=2;len<tab.rows[i].cells.length;len++)label[len-2]=="v1"?v1&&(tab.rows[i].cells[len].innerHTML=execute(datas[i-1].member_money_sum,datas[i-1].all_money_sum)):label[len-2]=="v2"?v2&&(tab.rows[i].cells[len].innerHTML=execute(datas[i-1].member_money_count,datas[i-1].all_money_count)):label[len-2]=="member_money_sum"?tab.rows[i].cells[len].innerHTML="<a ng-click='openConsume(data)'>"+datas[i-1].member_money_sum+"</a>":label[len-2]=="money_in_count"?tab.rows[i].cells[len].innerHTML="<a ng-click='openSaveMoney(data)'>"+datas[i-1].money_in_count+"</a>":label[len-2]=="integration_in_sum"?tab.rows[i].cells[len].innerHTML="<a ng-click='openIntegration(data)'>"+datas[i-1].integration_in_sum+"</a>":label[len-2]=="integration_out_sum"?tab.rows[i].cells[len].innerHTML="<a ng-click='openExchange(data)'>"+datas[i-1].integration_out_sum+"</a>":label[len-2]=="buy_card_count"?tab.rows[i].cells[len].innerHTML="<a ng-click='openBuyCard(data)'>"+datas[i-1].buy_card_count+"</a>":label[len-2]=="cancel_card_count"?tab.rows[i].cells[len].innerHTML="<a ng-click='openCancelCard(data)'>"+datas[i-1].cancel_card_count+"</a>":label[len-2]=="change_crad_type_count"?tab.rows[i].cells[len].innerHTML="<a ng-click='openChangeCardType(data)'>"+datas[i-1].change_crad_type_count+"</a>":label[len-2]=="update_card_count"?tab.rows[i].cells[len].innerHTML="<a ng-click='openUpdateCard(data)'>"+datas[i-1].update_card_count+"</a>":label[len-2]=="change_crad_date_count"?tab.rows[i].cells[len].innerHTML="<a ng-click='openChangeCardDate(data)'>"+datas[i-1].change_crad_date_count+"</a>":tab.rows[i].cells[len].innerHTML=datas[i-1][label[len-2]]}var selectMain,param,score,flag=0,label=["all_money_sum","member_money_sum","money_out_sum","givemoney_out_sum","v1","all_money_count","member_money_count","v2","money_in_count","money_in_sum","givemoney_in_sum","integration_in_count","integration_in_sum","integration_out_count","integration_out_sum","buy_card_count","buy_card_sum","cancel_card_count","cancel_card_sum","change_crad_type_count","update_card_count","change_crad_date_count"];define(["require","css!score_rule_css","css!trade_css","jquery","echart","ngAMD"],function(require){var apdp=require("css!score_rule_css"),css=require("css!trade_css"),$=require("jquery"),echart=require("echart"),module=angular.module("ajaxmodule"),ngAMD=require("ngAMD");return ngAMD.controller("comprehensive",["$scope","$rootScope","ajaxService","appConstant","register","$uibModal","getCookieService","$q",function($scope,$rootScope,ajaxService,appConstant,register,$uibModal,getCookieService,$q){score=$scope;var sessionId=$rootScope.sessionId,tabLabel1={all_money_sum:2,member_money_sum:3,money_out_sum:4,givemoney_out_sum:5,v1:6,all_money_count:7,member_money_count:8,v2:9,money_in_count:10,money_in_sum:11,givemoney_in_sum:12,integration_in_count:13,integration_in_sum:14,integration_out_count:15,integration_out_sum:16,buy_card_count:17,buy_card_sum:18,cancel_card_count:19,cancel_card_sum:20,change_crad_type_count:21,update_card_count:22,change_crad_date_count:23},param=null;try{param=JSON.parse(getCookieService.getCookie("COMPSELECTKPI"))}catch(e){param={all_money_sum:!0,member_money_sum:!0,money_out_sum:!0,givemoney_out_sum:!0,all_money_count:!0,member_money_count:!0,money_in_count:!0,money_in_sum:!0,givemoney_in_sum:!0,integration_in_count:!0,integration_in_sum:!0,integration_out_count:!0,integration_out_sum:!0,buy_card_count:!0,buy_card_sum:!0,cancel_card_count:!0,cancel_card_sum:!0,change_crad_type_count:!0,update_card_count:!0,change_crad_date_count:!0,v1:!0,v2:!0}}var labels=new Array,arrays=new Array,len=0;for(var x in param)param[x]&&(arrays[len]=x,labels[len]=tabLabel1[x],len+=1);param["v1"]==1&&(labels[len]=tabLabel1.v1,len+=1),param["v2"]==1&&(labels[len]=tabLabel1.v2,len+=1),DeleteSignColumn(labels),ajaxService.AjaxPost({sessionId:sessionId},"reportcenter/comprehensive/load.do").then(function(result){}),$scope.conditions={isCollapsed:!1,ajaxUrl:"reportcenter/comprehensive/list.do",request:{shopGroupFlag:!0,sessionId:sessionId,pageNo:"1",pageCount:appConstant.pageSet.numPerPage,field:arrays,shopFieldVo:param},filter:[{type:"normal",field:"卡型：",requestFiled:"cardTypes",value:[],ajaxUrl:"memberequity/cardtype/list.do",request:{sessionId:sessionId}},{type:"normal",field:"会员来源：",requestFiled:"memberOrigins",value:[],ajaxUrl:"reportcenter/memberOrigin/list.do",request:{sessionId:sessionId}}],datePicker:{requestFiled:["date","beginDate","endDate"],value:[{name:"今天",state:!0,value:0},{name:"昨天",state:!1,value:1},{name:"近7天",state:!1,value:7},{name:"近15天",state:!1,value:15},{name:"近30天",state:!1,value:30}]},more:!0},$scope.percentage=function(a,b){try{return b==0?"-":(a*100/b).toFixed(2)+"%"}catch(e){return"-"}},$scope.openSelectParam=function(){var deferred=$q.defer(),modalInstance=$uibModal.open({animation:!0,templateUrl:"resources/page/reportcenter/comprehensive/selectParam.html",controller:["$scope","$rootScope","$uibModalInstance","$state","ajaxService","getCookieService",function($scope,$rootScope,$uibModalInstance,$state,ajaxService,getCookieService){try{window.param=JSON.parse(getCookieService.getCookie("COMPSELECTKPI"));var param=window.param;$scope.all_money_sum=param.all_money_sum,$scope.member_money_sum=param.member_money_sum,$scope.money_out_sum=param.money_out_sum,$scope.givemoney_out_sum=param.givemoney_out_sum,$scope.all_money_count=param.all_money_count,$scope.member_money_count=param.member_money_count,$scope.money_in_count=param.money_in_count,$scope.money_in_sum=param.money_in_sum,$scope.givemoney_in_sum=param.givemoney_in_sum,$scope.integration_in_count=param.integration_in_count,$scope.integration_in_sum=param.integration_in_sum,$scope.integration_out_count=param.integration_out_count,$scope.integration_out_sum=param.integration_out_sum,$scope.buy_card_count=param.buy_card_count,$scope.buy_card_sum=param.buy_card_sum,$scope.cancel_card_count=param.cancel_card_count,$scope.cancel_card_sum=param.cancel_card_sum,$scope.change_crad_type_count=param.change_crad_type_count,$scope.update_card_count=param.update_card_count,$scope.change_crad_date_count=param.change_crad_date_count,$scope.v1=param.v1,$scope.v2=param.v2}catch(e){$scope.all_money_sum=!0,$scope.member_money_sum=!0,$scope.money_out_sum=!0,$scope.givemoney_out_sum=!0,$scope.all_money_count=!0,$scope.member_money_count=!0,$scope.v1=!0,$scope.v2=!0}$scope.closeTab=function(){$uibModalInstance.dismiss("cancel")},$scope.oo=function(){flag=1;var all_money_sum=$scope.all_money_sum,member_money_sum=$scope.member_money_sum,money_out_sum=$scope.money_out_sum,givemoney_out_sum=$scope.givemoney_out_sum,all_money_count=$scope.all_money_count,member_money_count=$scope.member_money_count,money_in_count=$scope.money_in_count,money_in_sum=$scope.money_in_sum,givemoney_in_sum=$scope.givemoney_in_sum,integration_in_count=$scope.integration_in_count,integration_in_sum=$scope.integration_in_sum,integration_out_count=$scope.integration_out_count,integration_out_sum=$scope.integration_out_sum,buy_card_count=$scope.buy_card_count,buy_card_sum=$scope.buy_card_sum,cancel_card_count=$scope.cancel_card_count,cancel_card_sum=$scope.cancel_card_sum,change_crad_type_count=$scope.change_crad_type_count,update_card_count=$scope.update_card_count,change_crad_date_count=$scope.change_crad_date_count,v1=$scope.v1,v2=$scope.v2;if(v1)if(!member_money_sum||!all_money_sum){alert("必须勾选上会员消费总数与总消费数");return}if(v2)if(!member_money_count||!all_money_count){alert("必须勾选上会员消费额与总消费额");return}param={all_money_sum:all_money_sum,member_money_sum:member_money_sum,money_out_sum:money_out_sum,givemoney_out_sum:givemoney_out_sum,all_money_count:all_money_count,member_money_count:member_money_count,money_in_count:money_in_count,money_in_sum:money_in_sum,givemoney_in_sum:givemoney_in_sum,integration_in_count:integration_in_count,integration_in_sum:integration_in_sum,integration_out_count:integration_out_count,integration_out_sum:integration_out_sum,buy_card_count:buy_card_count,buy_card_sum:buy_card_sum,cancel_card_count:cancel_card_count,cancel_card_sum:cancel_card_sum,change_crad_type_count:change_crad_type_count,update_card_count:update_card_count,change_crad_date_count:change_crad_date_count,v1:v1,v2:v2},labels=new Array,arrays=new Array,len=0;for(var x in param)param[x]&&(arrays[len]=x,labels[len]=tabLabel1[x],len+=1);v1&&(labels[len]=tabLabel1.v1,len+=1),v2&&(labels[len]=tabLabel1.v2,len+=1),DeleteSignColumn(labels),ajaxService.AjaxPost({shopGroupFlag:!0,sessionId:sessionId,pageNo:"1",pageCount:appConstant.pageSet.numPerPage,field:arrays,shopFieldVo:param},"reportcenter/comprehensive/list.do").then(function(result){$scope.resultList=result,loadtable(result.pageInfo.list,v1,v2),getCookieService.setCookie("COMPSELECTKPI",JSON.stringify(param))}),$uibModalInstance.dismiss("cancel")}}],size:"lg"})},selectMain=function(obj){var index=obj.selectedIndex,value=obj.options[index].value,postObj=$scope.requestObj.request;postObj.pageNo=$scope.pageSet.currentPage,postObj.pageCount=$scope.pageSet.numPerPage,postObj.shopGroupFlag=!1,postObj.cityGroupFlag=!1,postObj.brandGroupFlag=!1,postObj.monthGroupFlag=!1,postObj.weekGroupFlag=!1,postObj.workDayGroupFlag=!1,postObj[value]=!0,$("#title_name").text(obj.options[index].text),ajaxService.AjaxPost(postObj,$scope.conditions.ajaxUrl).then(function(result){$scope.resultList=result})},$scope.pageSet={title:"列表",currentPage:appConstant.pageSet.currentPage,maxSize:appConstant.pageSet.maxSize,numPerPage:appConstant.pageSet.numPerPage},$scope.pageChanged=function(){var postObj=$scope.requestObj.request;postObj.pageNo=$scope.pageSet.currentPage,postObj.pageCount=$scope.pageSet.numPerPage,postObj.field=arrays,postObj.shopFieldVo=param,postObj.change=!0,ajaxService.AjaxPost(postObj,$scope.conditions.ajaxUrl).then(function(result){$scope.resultList=result,flag==1&&loadtable(result.pageInfo.list,param.v1,param.v2)})},$scope.exportFile=function(){alert("报表功能正在开发中。。。")},$scope.openSaveMoney=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];shop.isOtherShop=0;try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}var index=document.getElementById("selectKPI").selectedIndex,value=document.getElementById("selectKPI").options[index].value;value=="shopGroupFlag"?shop.shopId=shop.id:value=="cityGroupFlag"?shop.cityId=shop.id:value=="brandGroupFlag"&&(shop.brandId=shop.id),register.addToTabs({title:"储值明细",id:"saveMoneyDesc"+shop.id,template:"reportcenter/savemoney/saveMoneyDesc.html",ctrl:"reportcenter/savemoney/saveMoneyDesc",ctrlName:"saveMoneyDesc",ng_show:!1,type:"single",from:1001},shop)},$scope.openConsume=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];shop.isOtherShop=0;try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}var index=document.getElementById("selectKPI").selectedIndex,value=document.getElementById("selectKPI").options[index].value;value=="shopGroupFlag"?shop.shopId=shop.id:value=="cityGroupFlag"?shop.cityId=shop.id:value=="brandGroupFlag"&&(shop.brandId=shop.id),register.addToTabs({title:"消费明细",id:"memberConsume"+shop.id,template:"reportcenter/savemoney/memberConsume.html",ctrl:"reportcenter/savemoney/memberConsume",ctrlName:"memberConsume",ng_show:!1,type:"single",from:1001},shop)},$scope.openIntegration=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}shop.shopId=shop.id,register.addToTabs({title:"积分明细",id:"integrationDesc"+shop.id,template:"reportcenter/integration/integrationDesc.html",ctrl:"reportcenter/integration/integrationDesc",ctrlName:"integrationDesc",ng_show:!1,type:"single",from:1002},shop)},$scope.openExchange=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];shop.isOtherShop=0;try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}var index=document.getElementById("selectKPI").selectedIndex,value=document.getElementById("selectKPI").options[index].value;value=="shopGroupFlag"?shop.shopId=shop.id:value=="cityGroupFlag"?shop.cityId=shop.id:value=="brandGroupFlag"&&(shop.brandId=shop.id),register.addToTabs({title:"兑换明细",id:"integrationExchange"+shop.id,template:"reportcenter/integration/integrationExchange.html",ctrl:"reportcenter/integration/integrationExchange",ctrlName:"integrationExchange",ng_show:!1,type:"single",from:1003},shop)},$scope.openBuyCard=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];shop.isOtherShop=0;try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}var index=document.getElementById("selectKPI").selectedIndex,value=document.getElementById("selectKPI").options[index].value;value=="shopGroupFlag"?shop.shopId=shop.id:value=="cityGroupFlag"?shop.cityId=shop.id:value=="brandGroupFlag"&&(shop.brandId=shop.id),register.addToTabs({title:"售卡记录",id:"buyCard"+shop.id,template:"reportcenter/comprehensive/buyCard.html",ctrl:"reportcenter/comprehensive/buyCard",ctrlName:"buyCard",ng_show:!1,type:"single",from:1003},shop)},$scope.openCancelCard=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];shop.isOtherShop=0;try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}var index=document.getElementById("selectKPI").selectedIndex,value=document.getElementById("selectKPI").options[index].value;value=="shopGroupFlag"?shop.shopId=shop.id:value=="cityGroupFlag"?shop.cityId=shop.id:value=="brandGroupFlag"&&(shop.brandId=shop.id),register.addToTabs({title:"退卡记录",id:"cancelCard"+shop.id,template:"reportcenter/comprehensive/cancelCard.html",ctrl:"reportcenter/comprehensive/cancelCard",ctrlName:"cancelCard",ng_show:!1,type:"single",from:1003},shop)},$scope.openChangeCardDate=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];shop.isOtherShop=0;try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}var index=document.getElementById("selectKPI").selectedIndex,value=document.getElementById("selectKPI").options[index].value;value=="shopGroupFlag"?shop.shopId=shop.id:value=="cityGroupFlag"?shop.cityId=shop.id:value=="brandGroupFlag"&&(shop.brandId=shop.id),register.addToTabs({title:"修改有效期",id:"changeCardDate"+shop.id,template:"reportcenter/comprehensive/changeCardDate.html",ctrl:"reportcenter/comprehensive/changeCardDate",ctrlName:"changeCardDate",ng_show:!1,type:"single",from:1003},shop)},$scope.openChangeCardType=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];shop.isOtherShop=0;try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}var index=document.getElementById("selectKPI").selectedIndex,value=document.getElementById("selectKPI").options[index].value;value=="shopGroupFlag"?shop.shopId=shop.id:value=="cityGroupFlag"?shop.cityId=shop.id:value=="brandGroupFlag"&&(shop.brandId=shop.id),register.addToTabs({title:"修改卡型",id:"changeCardType"+shop.id,template:"reportcenter/comprehensive/changeCardType.html",ctrl:"reportcenter/comprehensive/changeCardType",ctrlName:"changeCardType",ng_show:!1,type:"single",from:1003},shop)},$scope.showTab=function(param,name){return param.shopFieldVo[name]==1?"":"display:none"},$scope.showTab1=function(params,x,y,name){return param[name]==1?"":"display:none"},$scope.openUpdateCard=function(shop){var postObj=$scope.requestObj.request;for(var x in postObj)shop[x]=postObj[x];shop.isOtherShop=0;try{shop.date=$scope.requestObj.request.date}catch(e){shop.date=0}var index=document.getElementById("selectKPI").selectedIndex,value=document.getElementById("selectKPI").options[index].value;value=="shopGroupFlag"?shop.shopId=shop.id:value=="cityGroupFlag"?shop.cityId=shop.id:value=="brandGroupFlag"&&(shop.brandId=shop.id),register.addToTabs({title:"换卡",id:"updateCard"+shop.id,template:"reportcenter/comprehensive/updateCard.html",ctrl:"reportcenter/comprehensive/updateCard",ctrlName:"updateCard",ng_show:!1,type:"single",from:1003},shop)}}]),"comprehensive"});