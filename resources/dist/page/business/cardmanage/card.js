define(["require","css!score_rule_css","css!card_manage_css","ngAMD","business/cardmanage/batchSellCard","text!business/cardmanage/batchSellCard.html"],function(require){var app=require("css!score_rule_css"),card_manage_css=require("css!card_manage_css"),ngAMD=require("ngAMD"),batchSellCardCtrl=require("business/cardmanage/batchSellCard"),batchSellCardTemp=require("text!business/cardmanage/batchSellCard.html");return ngAMD.controller("cardCtrl",["$scope","register","getCookieService","appConstant","$rootScope","$uibModal","modalService","ajaxService",function($scope,register,getCookieService,appConstant,$rootScope,$uibModal,modalService,ajaxService){var sessionId=$rootScope.sessionId;$scope.openCardBtn=register.getRoot("开卡"),$scope.cancelOpenCardBtn=register.getRoot("取消开卡"),$scope.batchSellBtn=register.getRoot("批量售卡"),$scope.detailBtn=register.getRoot("详情"),$scope.conditions={ajaxUrl:"cardmanage/baseCardUsed/list.do",request:{sessionId:sessionId,pageNo:"1",pageCount:appConstant.pageSet.numPerPage},filter:[{type:"normal",field:"卡类型：",requestFiled:"cardTypeId",value:[],ajaxUrl:"memberequity/cardtype/getCardTypeForSearch.do",request:{sessionId:sessionId}},{type:"normal",field:"卡状态：",requestFiled:"cardStatus",value:[{name:"全部",state:!0,value:null},{name:"已售卡",state:!1,value:101},{name:"已挂失",state:!1,value:102},{name:"已退卡",state:!1,value:103},{name:"已作废",state:!1,value:104},{name:"黑名单",state:!1,value:105}]},{type:"normal",field:"过期状态：",requestFiled:"isOutOfDate",value:[{name:"全部",state:!0,value:null},{name:"正常",state:!1,value:"0"},{name:"过期",state:!1,value:"1"}]}],select:{requestFiled:"searchType",options:[{name:"卡号",state:!0,value:1},{name:"手机号",state:!1,value:2},{name:"门店名称",state:!1,value:3},{name:"会员标识",state:!1,value:4}]},search:{requestFiled:"searchTypeValue",request:{sessionId:sessionId,pageNo:"1",pageCount:appConstant.pageSet.numPerPage}}},$scope.pageSet={title:"卡列表",currentPage:appConstant.pageSet.currentPage,maxSize:appConstant.pageSet.maxSize,numPerPage:appConstant.pageSet.numPerPage},$scope.pageChanged=function(){var postObj=$scope.$$childTail.$$childHead.requestObj.request;postObj.pageNo=$scope.pageSet.currentPage,postObj.pageCount=$scope.pageSet.numPerPage,ajaxService.AjaxPost(postObj,$scope.conditions.ajaxUrl).then(function(result){$scope.$$childTail.$$childHead.resultList=result})},$scope.doCardDetail=function(baseCardUsed){baseCardUsed.callback=function a(callback){callback()},register.addToTabs({title:"卡账户详情",id:"cardDetail"+baseCardUsed.id,template:"business/cardmanage/cardDetail.html",ctrl:"business/cardmanage/cardDetail",ctrlName:"cardDetailCtrl",ng_show:!1,type:"single",from:10014},baseCardUsed)},$scope.conditions1={ajaxUrl:"opencardmanage/bmOpenCard/getOpenCardList.do",request:{sessionId:sessionId,pageNo:"1",pageCount:appConstant.pageSet.numPerPage}},$scope.pageSet1={currentPage:appConstant.pageSet.currentPage,maxSize:appConstant.pageSet.maxSize,numPerPage:appConstant.pageSet.numPerPage},$scope.changPage={},$scope.doOpenNewCard=function(){$scope.changPage.callback=function a(callback){$scope.pageChanged1()},register.addToTabs({title:"开卡",id:"openNewCard",template:"business/cardmanage/openNewCard.html",ctrl:"business/cardmanage/openNewCard",ctrlName:"openNewCardCtrl",ng_show:!1,type:"single",from:10014},$scope.changPage)},$scope.pageChanged1=function(){var postObj=$scope.$$childTail.$$childHead.openCardResultListRequest.request;postObj.pageNo=$scope.pageSet1.currentPage,postObj.pageCount=$scope.pageSet1.numPerPage,ajaxService.AjaxPost(postObj,$scope.conditions1.ajaxUrl).then(function(result){$scope.$$childTail.$$childHead.openCardResultList=result})},$scope.doCancelOpenCard=function(bmOpenCard){modalService.info({title:"提示",content:"是否取消此卡？",size:"sm",type:"todo"}).then(function(){ajaxService.AjaxPost({openCardBean:bmOpenCard,sessionId:sessionId},"opencardmanage/bmOpenCard/removeOpenCard.do").then(function(result){var status=result.status;status&&$scope.pageChanged1()})})},$scope.doUnsaledCard=function(bmOpenCard){$scope.changPage.callback=function a(callback){},register.addToTabs({title:"未售卡",id:"unSaledCards",template:"business/cardmanage/unsaledCard.html",ctrl:"business/cardmanage/unsaledCard",ctrlName:"unsaledCardCtrl",ng_show:!1,type:"multiple",from:10014},bmOpenCard)},$scope.doBatchSellCard=function(bmOpenCard){showBatchSellCardModal(bmOpenCard)};var showBatchSellCardModal=function(bmOpenCard){var modalInstance=$uibModal.open({animation:!0,template:batchSellCardTemp,size:"md",controller:"batchSellCardCtrl",resolve:{bmOpenCardModel:function(){return bmOpenCard}}});modalInstance.result.then(function(result){result.status&&($scope.pageChanged(),$scope.pageChanged1())})}}]),"cardCtrl"});