define(["require","css!score_rule_css","css!../../../assets/css/members","ngAMD","business/membermanage/memberBacklist","text!business/membermanage/memberBacklist.html"],function(require){var score_rule_css=require("css!score_rule_css"),membersCss=require("css!../../../assets/css/members"),ngAMD=require("ngAMD"),memberBacklistCtrl=require("business/membermanage/memberBacklist"),memberBacklistTemp=require("text!business/membermanage/memberBacklist.html");return ngAMD.controller("memberListCtrl",["$scope","$rootScope","$uibModal","register","appConstant","ajaxService","modalService",function($scope,$rootScope,$uibModal,register,appConstant,ajaxService,modalService){$scope.memberCardBtn=register.getRoot("会员卡"),$scope.sendMsgBtn=register.getRoot("发送消息"),$scope.editBtn=register.getRoot("修改"),$scope.detailBtn=register.getRoot("详情"),$scope.blackListBtn=register.getRoot("黑名单操作");var allDate=!0,toDay=!1,param=null;typeof $rootScope.searchRequest!="undefined"&&typeof $rootScope.searchRequest.select!="undefined"&&($rootScope.searchRequest.select=="toDay"&&(allDate=!1,toDay=!0,param=0),$rootScope.searchRequest.select=="all"&&(allDate=!0,toDay=!1));var sessionId=$rootScope.sessionId;$scope.conditions={ajaxUrl:"businessmanage/memberManage/list.do",request:{sessionId:sessionId,pageNo:"1",pageCount:appConstant.pageSet.numPerPage,joinDays:param},filter:[{type:"normal",field:"状态：",requestFiled:"memberStatus",value:[{name:"全部",state:!0,value:null},{name:"正常",state:!1,value:0},{name:"黑名单",state:!1,value:1}]},{type:"dateFlex",field:"加入时间：",requestFiled:"joinDays",value:[{name:"全部",state:allDate,value:null},{name:"今天",state:toDay,value:0},{name:"昨天",state:!1,value:1},{name:"近7天",state:!1,value:7},{name:"近15天",state:!1,value:15},{name:"近30天",state:!1,value:30}],requestFiled:["joinDays","memberBeginDate","memberEndDate"]}],select:{requestFiled:"searchType",options:[{name:"手机号",state:!1,value:2},{name:"卡号",state:!1,value:3},{name:"姓名",state:!0,value:1}]},search:{requestFiled:"searchTypeValue",request:{sessionId:sessionId}}},$scope.pageSet={title:"会员管理",currentPage:appConstant.pageSet.currentPage,maxSize:appConstant.pageSet.maxSize,numPerPage:appConstant.pageSet.numPerPage},$scope.doMemeberEdit=function(member){member.callback=function a(callback){$scope.pageChanged()},register.addToTabs({title:"完善会员资料",id:"mbemberUpdate"+member.id,template:"business/membermanage/memberEdit.html",ctrl:"business/membermanage/memberEdit",ctrlName:"memberEditCtrl",ng_show:!1,type:"single",from:10013},member)},$scope.doMemeberDetail=function(member){member.callback=function a(callback){callback()},register.addToTabs({title:"查看会员详情",id:"mbemberDetail"+member.id,template:"business/membermanage/memberDetail.html",ctrl:"business/membermanage/memberDetail",ctrlName:"memberDetailCtrl",ng_show:!1,type:"single",from:10013},member)},$scope.doMemberStatus=function(member){if(!member.status)showMemberBacklistModal(member);else{var data={id:member.id,status:member.status},param={member:data,sessionId:$rootScope.sessionId};ajaxService.AjaxPost(param,"businessmanage/memberManage/updateMemberStatus.do").then(function(result){member.status=result.member.status,member.status?modalService.info({title:"提示",content:"加入黑名单成功!",size:"sm",type:"confirm"}):modalService.info({title:"提示",content:"移除黑名单成功!",size:"sm",type:"confirm"})})}};var showMemberBacklistModal=function(member){var modalInstance=$uibModal.open({animation:!0,template:memberBacklistTemp,size:"sm",controller:"memberBacklistCtrl",resolve:{memberObjModel:function(){return member}}});modalInstance.result.then(function(updateMember){member.status=updateMember.status,member.status?modalService.info({title:"提示",content:"加入黑名单成功!",size:"sm",type:"confirm"}):modalService.info({title:"提示",content:"移除黑名单成功!",size:"sm",type:"confirm"})})};$scope.pageChanged=function(){var postObj=$scope.$$childTail.$$childHead.requestObj.request;postObj.pageNo=$scope.pageSet.currentPage,postObj.pageCount=$scope.pageSet.numPerPage,ajaxService.AjaxPost(postObj,$scope.conditions.ajaxUrl).then(function(result){$scope.$$childTail.$$childHead.resultList=result})},$scope.doCardDetail=function(member){register.openTabWithRequest({id:10014},{searchType:4,searchTypeValue:member.id})},$scope.popBacklistInfo=function(member){ajaxService.AjaxPost({memberId:member.id,sessionId:$rootScope.sessionId},"businessmanage/memberBacklist/getLastBackListRec.do").then(function(result){if(result.data){var lastBacklist=result.data,message=" 操作人："+lastBacklist.createUserName+" 操作时间："+lastBacklist.createTime+" 备注："+lastBacklist.note;modalService.info({title:"操作详情",content:message,size:"sm",type:"confirm"})}})}}]),"memberListCtrl"});