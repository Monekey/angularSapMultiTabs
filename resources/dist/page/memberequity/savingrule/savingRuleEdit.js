define(["require","ngAMD","angular","shopSelector"],function(require){var ngAMD=require("ngAMD"),angular=require("angular"),shopselector=require("shopSelector");ngAMD.controller("savingRuleEdit",["$scope","$rootScope","ajaxService","getCookieService","register","shopSelectorService","modalService",function($scope,$rootScope,ajaxService,getCookieService,register,shopSelectorService,modalService){function FormatDate(strTime){var date=new Date(strTime),year=date.getFullYear(),month=date.getMonth()+1<10?"0"+(date.getMonth()+1):date.getMonth()+1,day=date.getDate()<10?"0"+date.getDate():date.getDate();return year+"-"+month+"-"+day}function convertModalShop(shops){var newShops=[];for(var i=0;i<shops.length;i++){var shop={};shop.code=shops[i].code,shop.showName=shops[i].showName,shop.bindFlg=shops[i].bindFlg,shop.shopName=shops[i].shopName,newShops.push(shop)}return newShops}$scope.date_seven=[],$scope.rule_data={id:$rootScope.TabsData.id,sessionId:$rootScope.sessionId,terminal:[],relTerminals:[],week:[],givingInfo:[{limitMoney:null,givingType:0,givingMoney:null,givingProportion:null},{limitMoney:null,givingType:1,givingMoney:null,givingProportion:null}],savingRule:{name:"",savingType:0,givingType:0,isTerminal:0,isDate:0,isTime:0,isWeek:0,startTime:"",endTime:"",note:"",isAble:1}},$scope.moneyTypeCount=1,$scope.poportionTypeCount=1,$scope.add=function(type){type==0?$scope.moneyTypeCount++:type==1&&$scope.poportionTypeCount++;var addObj={money:null,givingType:type,givingMoney:null,givingProportion:null};$scope.rule_data.givingInfo.push(addObj)},$scope.reduce=function(index,type){type==0?$scope.moneyTypeCount--:type==1&&$scope.poportionTypeCount--,$scope.rule_data.givingInfo.splice(index,1)},$scope.getWeeks=function(){var t=$scope.rule_data.type,choseWeeks=[];angular.forEach($scope.date_seven,function(j){j.state==1&&choseWeeks.push(j.value)}),this.rule_data.week=choseWeeks};var data=angular.copy($rootScope.TabsData);$scope.rule_data.savingRule=data,$scope.from=data.from,$scope.rule_data.savingRule.startTime=FormatDate(new Date(data.startTime)),$scope.rule_data.savingRule.endTime=FormatDate(new Date(data.endTime)),$scope.status={terminal:$scope.rule_data.savingRule&&$scope.rule_data.savingRule.isTerminal===1?!0:!1,date:$scope.rule_data.savingRule&&$scope.rule_data.savingRule.isDate===1?!0:!1},$scope.openPanel=function(type){type==="terminal"&&$scope.rule_data.savingRule.isTerminal===1&&($scope.status.terminal=!0),type==="date"&&$scope.rule_data.savingRule.isDate===1&&($scope.status.date=!0);var event=window.event||event;document.all?event.cancelBubble=!0:event.stopPropagation()},ajaxService.AjaxPost({sessionId:$rootScope.sessionId,id:data.id,type:data.givingType},"memberEquity/savingRule/detaillist.do").then(function(result){$scope.rule_data.givingInfo=result.savingRuleDetails,data.givingType==0?($scope.moneyTypeCount=result.savingRuleDetails.length,$scope.rule_data.givingInfo.push({savingRuleId:data.id,limitMoney:null,givingType:1,givingMoney:null,givingProportion:null})):($scope.poportionTypeCount=result.savingRuleDetails.length,$scope.rule_data.givingInfo.push({savingRuleId:data.id,limitMoney:null,givingType:0,givingMoney:null,givingProportion:null}))}),$scope.initWeeks=[{date:"星期一",state:!1,value:1},{date:"星期二",state:!1,value:2},{date:"星期三",state:!1,value:3},{date:"星期四",state:!1,value:4},{date:"星期五",state:!1,value:5},{date:"星期六",state:!1,value:6},{date:"星期日",state:!1,value:7}],ajaxService.AjaxPost({sessionId:$rootScope.sessionId,id:data.id},"memberEquity/savingRule/weeklist.do").then(function(result){for(var i in $scope.initWeeks){var x={};x.date=$scope.initWeeks[i].date,x.value=$scope.initWeeks[i].value,x.state=!1;for(var j=0;j<result.week.length;j++)if(result.week[j]==$scope.initWeeks[i].value){x.state=!0;break}$scope.date_seven.push(x)}}),$scope.date_seven_click=function(i){i.state=!i.state;if(i.state==0&&$scope.rule_data.savingRule.isWeek==1){var tempFlg=!1;angular.forEach($scope.date_seven,function(j){j.state==1&&(tempFlg=!0)}),tempFlg||(i.state=!i.state,modalService.info({title:"提示",content:"开启有效星期，具体生效星期X至少有一个!",size:"sm",type:"confirm"}))}},$scope.isWeekChange=function(){if($scope.rule_data.savingRule.isWeek==1){var tempFlg=!1;angular.forEach($scope.date_seven,function(j){j.state==1&&(tempFlg=!0),console.log(j.state)}),tempFlg||angular.forEach($scope.date_seven,function(j){j.state=!0})}},$scope.confirmDetail=function(){var type=$scope.rule_data.savingRule.givingType,choseDetail=[];angular.forEach($scope.rule_data.givingInfo,function(j){j.givingType==type&&choseDetail.push(j)}),$scope.rule_data.givingInfo=choseDetail};var initItems=[];ajaxService.AjaxPost({sessionId:$rootScope.sessionId,id:data.id},"memberEquity/savingRule/relTerminals.do").then(function(result){$scope.rule_data.relTerminals=result.relTerminals,initItems=angular.copy(result.relTerminals)}),$scope.showModal=function(){var showFlg=1,currentItems=$scope.rule_data.relTerminals,selectorParam={serviceType:"terminal",terminal:{ajaxUrl:"baseData/terminalManager/treeList.do"},initItems:initItems,currentItems:currentItems,showFlg:1,title:"选择终端"};shopSelectorService.openShopModal(selectorParam).then(function(result){$scope.rule_data.relTerminals=convertModalShop(result.allSelectedItems),$scope.changeItems=result.changeItems})},$scope.checkDateLimit=function(){return $scope.rule_data.savingRule.isDate==1&&$scope.rule_data.savingRule.isTime==0&&$scope.rule_data.savingRule.isWeek==0?!1:!0},$scope.checkGivingHasRepeat=function(){var givingInfo=$scope.rule_data.givingInfo,fullMoneys=[];angular.forEach(givingInfo,function(j){fullMoneys.push(j.limitMoney)});var nary=fullMoneys.sort();for(var i=0;i<fullMoneys.length;i++)if(nary[i]==nary[i+1])return!0;return!1},$scope.confirmIn=function(){$scope.getWeeks(),$scope.confirmDetail();if($scope.checkGivingHasRepeat()){modalService.info({title:"提示",content:"赠送规则内容里，充值金额列不应有重复项，请修改！",size:"sm",type:"confirm"});return}if(!$scope.checkDateLimit()){modalService.info({title:"提示",content:"您已开启有效期限制，请至少选中和设置一个限制条件!",size:"sm",type:"confirm"});return}if($scope.rule_data.savingRule.isTime==1&&$scope.rule_data.savingRule.startTime==""&&$scope.rule_data.savingRule.endTime==""){modalService.info({title:"提示",content:"有效日期已经开启，请填写起止时间！",size:"sm",type:"confirm"});return}var startDate=new Date,endDate=new Date;$scope.rule_data.savingRule.startTime!==""&&(startDate=new Date($scope.rule_data.savingRule.startTime)),startDate.setHours(0),startDate.setMinutes(0),startDate.setSeconds(0),startDate.setMilliseconds(0),$scope.rule_data.savingRule.startTime=startDate.getTime(),$scope.rule_data.savingRule.endTime!==""&&(endDate=new Date($scope.rule_data.savingRule.endTime)),endDate.setHours(23),endDate.setMinutes(59),endDate.setSeconds(59),endDate.setMilliseconds(0),$scope.rule_data.savingRule.endTime=endDate.getTime(),$scope.scoreRlueEdit=angular.copy($scope.rule_data),$scope.changeItems&&$scope.changeItems.length>0?$scope.scoreRlueEdit.relTerminals=$scope.changeItems:$scope.scoreRlueEdit.relTerminals=[],ajaxService.AjaxPost($scope.scoreRlueEdit,"memberEquity/savingRule/update.do").then(function(result){result&&result.status===1&&modalService.info({title:"提示",content:"修改成功!",size:"sm",type:"ok"}).then(function(obj){obj.status=="ok"&&($rootScope.TabsData.callback(),register.switchTab({id:$scope.from}))})})},$scope.cancelIn=function(){register.switchTab({id:$scope.from})},$scope.stopPropagation=function($event){$event.stopPropagation()}}])});