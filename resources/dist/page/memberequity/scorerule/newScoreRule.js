define(["require","ngAMD","shopSelector"],function(require){var ngAMD=require("ngAMD"),shopselector=require("shopSelector");ngAMD.controller("newScoreRule",["$scope","$rootScope","ajaxService","getCookieService","register","shopSelectorService","modalService",function($scope,$rootScope,ajaxService,getCookieService,register,shopSelectorService,modalService){function convertModalShop(shops){var newShops=[];for(var i=0;i<shops.length;i++){var shop={};shop.code=shops[i].code,shop.showName=shops[i].showName,shop.bindFlg=shops[i].bindFlg,shop.shopName=shops[i].shopName,newShops.push(shop)}return newShops}$scope.from=$rootScope.TabsData.from,$scope.status={terminal:!1,date:!1},$scope.operationData=[{name:"消费",state:!0,id:1,type:0},{name:"充值",state:!1,id:2,type:0},{name:"售卡",state:!1,id:3,type:1},{name:"微信分享",state:!1,id:4,type:1},{name:"菜品评价",state:!1,id:5,type:1},{name:"好友邀请",state:!1,id:6,type:1},{name:"微信签到",state:!1,id:7,type:1}],$scope.rule_data={sessionId:$rootScope.sessionId,terminal:[],relTerminals:[],operation:[],week:[],scoreRule:{name:"",howMoney:1,howScore:1,multiple:2,handling:"1",isTerminal:0,isDate:0,isTime:0,isBirthday:0,isWeek:0,startTime:"",endTime:"",note:"",type:0,isAble:1}},$scope.choseOperations=[],$scope.showChar="消费",$scope.operation=function(i,type){angular.forEach($scope.operationData,function(j){j.type==type&&(j.state=!1)}),i.state=!i.state,$scope.showChar=i.name},$scope.getOperations=function(){var type=$scope.rule_data.scoreRule.type,choseOperations=[];angular.forEach($scope.operationData,function(j){j.type==type&&j.state==1&&choseOperations.push(j.id)}),$scope.rule_data.operation=choseOperations},$scope.getWeeks=function(){var t=$scope.rule_data.scoreRule.type,choseWeeks=[];angular.forEach($scope.date_seven,function(j){j.state==1&&choseWeeks.push(j.value)}),$scope.rule_data.week=choseWeeks},$scope.date_seven=[{date:"星期一",state:!1,value:1},{date:"星期二",state:!1,value:2},{date:"星期三",state:!1,value:3},{date:"星期四",state:!1,value:4},{date:"星期五",state:!1,value:5},{date:"星期六",state:!1,value:6},{date:"星期日",state:!1,value:7}],$scope.date_seven_click=function(i){i.state=!i.state;if(i.state==0&&$scope.rule_data.scoreRule.isWeek==1){var tempFlg=!1;angular.forEach($scope.date_seven,function(j){j.state==1&&(tempFlg=!0)}),tempFlg||(i.state=!i.state,modalService.info({title:"提示",content:"开启有效星期，具体生效星期X至少有一个!",size:"sm",type:"confirm"}))}},$scope.isWeekChange=function(){if($scope.rule_data.scoreRule.isWeek==1){var tempFlg=!1;angular.forEach($scope.date_seven,function(j){j.state==1&&(tempFlg=!0),console.log(j.state)}),tempFlg||angular.forEach($scope.date_seven,function(j){j.state=!0})}},$scope.showModal=function(){var showFlg=1,initItems=[],currentItems=$scope.rule_data.relTerminals,paramSet={serviceType:"terminal",terminal:{ajaxUrl:"baseData/terminalManager/treeList.do"},initItems:initItems,currentItems:currentItems,showFlg:1,title:"选择终端"};shopSelectorService.openShopModal(paramSet).then(function(result){$scope.rule_data.relTerminals=convertModalShop(result.allSelectedItems),$scope.changeItems=result.changeItems})},$scope.checkDateLimit=function(){return $scope.rule_data.scoreRule.isDate==1&&$scope.rule_data.scoreRule.isTime==0&&$scope.rule_data.scoreRule.isWeek==0?!1:!0},$scope.confirmIn=function(){$scope.getOperations();if($scope.rule_data.scoreRule.startTime===""){var startDate=new Date;startDate.setHours(0),startDate.setMinutes(0),startDate.setSeconds(0),startDate.setMilliseconds(0),$scope.rule_data.scoreRule.startTime=startDate.getTime()}if($scope.rule_data.scoreRule.endTime===""){var endDate=new Date;endDate.setHours(23),endDate.setMinutes(59),endDate.setSeconds(59),endDate.setMilliseconds(0),$scope.rule_data.scoreRule.endTime=endDate.getTime()}if($scope.rule_data.operation.length==0)return modalService.info({title:"提示",content:"请至少勾选一个积分操作",size:"sm",type:"confirm"}),!1;$scope.getWeeks();if(!$scope.checkDateLimit()){modalService.info({title:"提示",content:"您已开启有效期限制，请至少选中和设置一个限制条件!",size:"sm",type:"confirm"});return}if($scope.rule_data.scoreRule.isTime==1&&$scope.rule_data.scoreRule.startTime==""&&$scope.rule_data.scoreRule.endTime==""){modalService.info({title:"提示",content:"有效日期已经开启，请填写起止时间！",size:"sm",type:"confirm"});return}$scope.scoreRlueEdit=$scope.rule_data,$scope.changeItems&&$scope.changeItems.length>0&&($scope.scoreRlueEdit.relTerminals=$scope.changeItems),$scope.disabledBtn=!0,ajaxService.AjaxPost($scope.scoreRlueEdit,"memberEquity/scoreRule/create.do").then(function(result){result&&result.status===1&&modalService.info({title:"提示",content:"新建成功!",size:"sm",type:"ok"}).then(function(obj){obj.status=="ok"&&($rootScope.TabsData.callback(),register.switchTab({id:$scope.from}))})}),$scope.disabledBtn=!1},$scope.cancelIn=function(){register.switchTab({id:$scope.from})},$scope.openPanel=function(type){type==="terminal"&&($scope.status.terminal=!0),type==="date"&&($scope.status.date=!0);var event=window.event||event;document.all?event.cancelBubble=!0:event.stopPropagation()},$scope.stopPropagation=function($event){$event.stopPropagation()}}])});