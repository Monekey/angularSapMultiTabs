define(["require","ngAMD","angular","shopSelector","memberequity/cardtype/savingSelector","text!memberequity/cardtype/savingSelector.html","memberequity/cardtype/scoreSelector","text!memberequity/cardtype/scoreSelector.html","memberequity/cardtype/exchangeSelector","text!memberequity/cardtype/exchangeSelector.html"],function(require){var ngAMD=require("ngAMD"),angular=require("angular"),shopselector=require("shopSelector"),savingSelectorCtrl=require("memberequity/cardtype/savingSelector"),savingSelectorTemp=require("text!memberequity/cardtype/savingSelector.html"),scoreSelectorCtrl=require("memberequity/cardtype/scoreSelector"),scoreSelectorTemp=require("text!memberequity/cardtype/scoreSelector.html"),exchangeSelectorCtrl=require("memberequity/cardtype/exchangeSelector"),exchangeSelectorTemp=require("text!memberequity/cardtype/exchangeSelector.html");ngAMD.controller("cardTypeCreate",["$scope","$rootScope","ajaxService","register","shopSelectorService","$uibModal","modalService",function($scope,$rootScope,ajaxService,register,shopSelectorService,$uibModal,modalService){function addSelectTag(datas){for(var i=0;i<datas.length;i++)datas[i].$selectTag=datas[i].isBound;return datas}function getDays(month){var days=[],date=new Date((new Date).getFullYear(),month,0),daysCount=date.getDate();for(var i=1;i<=daysCount;i++)days.push(i<10?"0"+i:i+"");return days}function inArray(arr,item){for(var i=0;i<arr.length;i++)if(arr[i].id==item.id)return i;return-1}function getCurrentTabId(){var tabs=$rootScope.tabs;for(var i=0;i<tabs.length;i++)if(tabs[i].ng_show===!0)return tabs[i].id;return $scope.from}function convertModalShop(shops){var newShops=[];for(var i=0;i<shops.length;i++){var shop={};shop.code=shops[i].code,shop.showName=shops[i].showName,shop.bindFlg=shops[i].bindFlg,newShops.push(shop)}return newShops}$scope.from=$rootScope.TabsData.from;var sessionId=$rootScope.sessionId;$scope.status={score:!1,exchange:!1,recharge:!1,limit:!1,remind:!1},$scope.openPanel=function(type){type==="score"&&($scope.status.score=!0),type==="exchange"&&($scope.status.exchange=!0),type==="recharge"&&($scope.status.recharge=!0),type==="limit"&&($scope.status.limit=!0),type==="remind"&&($scope.status.remind=!0);var event=window.event||event;document.all?event.cancelBubble=!0:event.stopPropagation()},$scope.scoreWay={0:"按金额",1:"按操作"},$scope.exchangeWay={0:"电子券",1:"实物"},$scope.savingWay={0:"线上储值",1:"线下储值"},$scope.cardTypeEdit={baseInfo:{},scoreSet:{},relSavingRules:[],relExchangeRules:[],limitSet:{}},$scope.relSavingRules=[],$scope.scoreSet={},$scope.scoreSet.relScoreRules=[],$scope.relExchangeRules=[],$scope.$watch("status.limit",function(limit){limit&&limit===!0&&ajaxService.AjaxPost({sessionId:sessionId},"memberequity/cardtype/limitSet.do").then(function(result){result&&($scope.limitSet=result.limitSet)})}),$scope.tables=[{id:1,name:"dsfgfd"},{id:2,name:"dsfgfd"},{id:3,name:"dsfgfd"},{id:4,name:"dsfgfd"},{id:5,name:"dsfgfd"},{id:6,name:"dsfgfd"},{id:7,name:"dsfgfd"},{id:8,name:"dsfgfd"},{id:9,name:"dsfgfd"},{id:10,name:"dsfgfd"},{id:11,name:"dsfgfd"},{id:12,name:"dsfgfd"}],$scope.months=["01","02","03","04","05","06","07","08","09","10","11","12"],$scope.days=getDays((new Date).getMonth()),$scope.changeMonth=function(month){$scope.days=getDays(month)};var currentTabId=getCurrentTabId(),newScoreTab={title:"新建积分规则",id:"newScoreRule",template:"memberequity/scorerule/newScoreRule.html",ctrlName:"newScoreRule",ctrl:"memberequity/scorerule/newScoreRule",from:currentTabId,type:"multiple",ng_show:!1},newExcahngeTab={title:"新建兑换规则",id:"newExchangeRule",ctrlName:"newExchangeRule",ctrl:"memberequity/exchangerule/newExchangeRule",template:"memberequity/exchangerule/newExchangeRule.html",from:currentTabId,type:"multiple",ng_show:!1},newRechargeTab={title:"新建储值规则",id:"newSavingRule",ctrl:"memberequity/savingrule/newSavingRule",ctrlName:"newSavingRule",template:"memberequity/savingrule/newSavingRule.html",from:currentTabId,type:"multiple",ng_show:!1};$scope.createNew=function(type){type&&(type==="score"&&register.addToTabs(newScoreTab,{callback:function a(){}}),type==="exchange"&&register.addToTabs(newExcahngeTab,{callback:function a(){}}),type==="recharge"&&register.addToTabs(newRechargeTab,{callback:function a(){}}))},$scope.showModal=function(){var showFlg=1,initItems=[],currentItems=$scope.limitSet.relShops,paramSet={serviceType:"shop",shop:{brand:1,city:2,ajaxUrl:"baseData/shopManager/getShopTree.do"},initItems:initItems,currentItems:currentItems,showFlg:1,title:"选择门店"};shopSelectorService.openShopModal(paramSet).then(function(result){$scope.limitSet.relShops=convertModalShop(result.allSelectedItems),$scope.changeItems=result.changeItems})},$scope.cancelIn=function(){register.switchTab({id:$scope.from})},$scope.confirmSave=function(){$scope.scoreSet.relScoreRules.length>0&&($scope.cardTypeEdit.scoreSet.relScoreRules=$scope.scoreSet.relScoreRules),$scope.cardTypeEdit.scoreSet.clearMonth&&$scope.cardTypeEdit.scoreSet.clearDay&&($scope.cardTypeEdit.scoreSet.clearDate=$scope.cardTypeEdit.scoreSet.clearMonth+"-"+$scope.cardTypeEdit.scoreSet.clearDay),$scope.relExchangeRules.length>0&&($scope.cardTypeEdit.relExchangeRules=$scope.relExchangeRules),$scope.relSavingRules.length>0&&($scope.cardTypeEdit.relSavingRules=$scope.relSavingRules),$scope.changeItems&&$scope.changeItems.length>0&&($scope.cardTypeEdit.limitSet.relShops=$scope.changeItems);if($scope.cardTypeEdit.baseInfo.isUseLimit===1){var checkOneItem=!1;for(var p in $scope.cardTypeEdit.limitSet)p==="isFirstConsume"&&$scope.cardTypeEdit.limitSet[p]===1&&(checkOneItem=!0),p==="isMinRecharge"&&$scope.cardTypeEdit.limitSet[p]===1&&(checkOneItem=!0),p==="isShopLimit"&&$scope.cardTypeEdit.limitSet[p]===1&&(checkOneItem=!0);if(checkOneItem===!1){modalService.info({title:"提示",content:"您已开启使用限制，请至少选择一条使用限制!",size:"sm",type:"confirm"});return}}$scope.ruleData=$scope.cardTypeEdit,$scope.ruleData.sessionId=sessionId,$scope.disabledBtn=!0,ajaxService.AjaxPost($scope.ruleData,"memberequity/cardtype/create.do").then(function(result){result&&result.status===1&&(selectRelScoreRules=[],selectExchanges=[],modalService.info({content:"新建成功",type:"ok"}).then(function(obj){obj.status=="ok"&&($rootScope.TabsData.callback(),register.switchTab({id:$scope.from}))}))}),$scope.disabledBtn=!1},$scope.minus=function(rules,$index){rules.splice($index,1)},$scope.up=function(rules,$index){var tempRule=rules[$index];rules[$index]=rules[$index-1],rules[$index-1]=tempRule},$scope.down=function(rules,$index){var tempRule=rules[$index];rules[$index]=rules[$index+1],rules[$index+1]=tempRule},$scope.showSavingModal=function(){var modalInstance=$uibModal.open({animation:!0,template:savingSelectorTemp,size:"lg",controller:"savingSelectorCtrl",resolve:{ruleIds:function(){var ruleIds=[];return $scope.relSavingRules.forEach(function(v){ruleIds.push(v.id)}),ruleIds}}});modalInstance.result.then(function(selectedItem){selectedItem.forEach(function(v){$scope.relSavingRules.push(v)})})},$scope.showScoreModal=function(){var modalInstance=$uibModal.open({animation:!0,template:scoreSelectorTemp,size:"lg",controller:"scoreSelectorCtrl",resolve:{ruleIds:function(){var ruleIds=[];return $scope.scoreSet.relScoreRules.forEach(function(v){ruleIds.push(v.id)}),ruleIds}}});modalInstance.result.then(function(selectedItem){selectedItem.forEach(function(v){$scope.scoreSet.relScoreRules.push(v)})})},$scope.stopPropagation=function($event){$event.stopPropagation()},$scope.showExchangeModal=function(){var modalInstance=$uibModal.open({animation:!0,template:exchangeSelectorTemp,size:"lg",controller:"exchangeSelectorCtrl",resolve:{ruleIds:function(){var ruleIds=[];return $scope.relExchangeRules.forEach(function(v){ruleIds.push(v.id)}),ruleIds}}});modalInstance.result.then(function(selectedItem){selectedItem.forEach(function(v){$scope.relExchangeRules.push(v)})})}}])});