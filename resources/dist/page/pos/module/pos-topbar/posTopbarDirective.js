define(["ngAMD","devices","css!pos_css"],function(ngAMD){ngAMD.directive("posTopbar",[function(){return{restrict:"E",scope:{userTerminal:"=",shopTerminals:"="},replace:"true",templateUrl:"resources/page/pos/module/pos-topbar/posTopbar.html",controller:"com.tcsl.crm7.posTopbarController"}}]),ngAMD.controller("com.tcsl.crm7.posTopbarController",["$scope","$rootScope","ajaxService","getCookieService","$state","$interval","modalService","devicesService",function($scope,$rootScope,ajaxService,getCookieService,$state,$interval,modalService,devicesService){var data={sessionId:$rootScope.sessionId};ajaxService.AjaxPost(data,"postrade/memberhome/userterminal.do").then(function(result){if(result.data!=null){$scope.userTerminal=result.data;var search={shopId:result.data.shopId,sessionId:$rootScope.sessionId};$state.go("pos.selectedpos")}else{$scope.userTerminal=null;var search={shopId:result.shopId,sessionId:$rootScope.sessionId};$state.go("pos.default")}ajaxService.AjaxPost(search,"postrade/memberhome/usershopterminal.do").then(function(result){result.data!=null&&($scope.shopTerminals=result.data)})}),$scope.posTestss=function(){var data={businessType:1,printSetInfosBeans:$rootScope.printSetInfos,dataPkgObj:"10000110000001830",sessionId:$rootScope.sessionId};ajaxService.AjaxPost(data,"pos/print/printBill.do").then(function(result){result.status===1&&devicesService.design(result.data)})},$scope.switchTerminal=function(){$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null,$state.go("pos.default")},devicesService.init(),ajaxService.AjaxPost(data,"pos/printset/getPrintSet.do").then(function(result){result.status===1?$rootScope.printSetInfos=result.data:$rootScope.printSetInfos=null,console.log($rootScope.printSetInfos)}),$scope.posPrint=function(){$scope.posPrinter=!0,$scope.serialData=null,$scope.printStartTime=(new Date).getTime(),$scope.printEndTime=(new Date).getTime();var param={startTime:$scope.printStartTime,endTime:$scope.printEndTime,sessionId:$rootScope.sessionId};ajaxService.AjaxPost(param,"pos/print/printSerialBill.do").then(function(result){result.status===1&&($scope.serialData=result.data)})},$scope.printTest=function(){if($scope.serialData!=null){var param={businessType:4,printSetInfosBeans:$rootScope.printSetInfos,dataPkgObj:$scope.serialData,sessionId:$rootScope.sessionId};ajaxService.AjaxPost(param,"pos/print/printBill.do").then(function(result){result.status===1&&devicesService.preview(result.data)})}},$scope.posPrintSet=function(){$scope.posPrinterSet=!0,$scope.printers=$rootScope.printers,$scope.printSet={printStyle:"2",Url:"",printSetInfos:[{}]},$rootScope.printSetInfos!=null?$scope.printSet.printSetInfos=$rootScope.printSetInfos:ajaxService.AjaxPost(data,"pos/printset/getPrintSet.do").then(function(result){result.status===1&&($rootScope.printSetInfos=result.data,$scope.printSet.printSetInfos=$rootScope.printSetInfos)})},$scope.closePosPrint=function(){$scope.posPrinter=!1},$scope.closeposPrinterSet=function(){$scope.posPrinterSet=!1},$scope.currDate={year:"",mouth:"",date:"",day:"",time:""};var today=new Date,year=today.getFullYear(),month=today.getMonth()+1,date=today.getDate(),day=today.getDay(),week="";day==0&&(week="星期日"),day==1&&(week="星期一"),day==2&&(week="星期二"),day==3&&(week="星期三"),day==4&&(week="星期四"),day==5&&(week="星期五"),day==6&&(week="星期六"),$scope.currDate.year=year,$scope.currDate.month=month,$scope.currDate.date=date,$scope.currDate.day=week,$interval(function(){var myDate=new Date,hours=myDate.getHours()<10?"0"+myDate.getHours():myDate.getHours(),minutes=myDate.getMinutes()<10?"0"+myDate.getMinutes():myDate.getMinutes(),seconds=myDate.getSeconds()<10?"0"+myDate.getSeconds():myDate.getSeconds();$scope.currDate.time=hours+":"+minutes+":"+seconds},1e3),$scope.lockSystem=function(){getCookieService.setCookie("CRM7LOCK",!0)}}])});