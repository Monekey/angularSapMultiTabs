define(["angular","ui_bootstrap","ng_animate","esegece","sgc","base64"],function(angular){var modalModule=angular.module("com.tcsl.crm7.devices",["ui.bootstrap","ngAnimate"]);modalModule.factory("devicesService",["$uibModal","$q","$rootScope","$window",function($uibModal,$q,$rootScope,$window){var TDevices=new function(){function extend(){var copy,name,target=arguments[0]||{},i=1,length=arguments.length;for(;i<length;i++)if((options=arguments[i])!=null)for(name in options)copy=options[name],copy!==undefined&&(target[name]=copy);return target}function getWsSetting(opt){return _setting=extend(_setting,opt),_setting}function setAttr(socket,setting){for(var key in setting){var index=key.indexOf("on");index==0&&setting[key]&&socket.on(key.substring(2,key.length),setting[key])}setting.globle_opt&&(tdevs.globle_opt=setting.globle_opt)}function dlog(m,o){tdevs.debug&&(console.log(m),o&&console.log(o))}var tdevs=this;tdevs.debug=!1;var OpenExe=function(enable){enable!=undefined?this.enable=enable:this.enable=!0};OpenExe.DEFAULTS={whichExe:1,event:0},OpenExe.prototype.handle=function(opt){if(!this.enable){dlog("外部程序打开驱动未启用！");return}this.options=extend({},OpenExe.DEFAULTS,opt),tdevs.rpc(GUID(),"tcsl.execute.open",this.options)},$window.OpenExe=OpenExe;var FastReport=function(enable){this.enable=enable,this.oper=FastReport.OPER;if(!tdevs.isWin){this.enable=!1;return}};FastReport.DEFAULTS={fileid:0,exporttype:1,printer:"report"},FastReport.OPER={cmd:{printerlist:"tcsl.report.printer_list",design:"tcsl.report.design",preview:"tcsl.report.preview",print:"tcsl.report.print",export_data:"tcsl.report.export_data",seturl:"tcsl.report.set_url"}},FastReport.prototype.handle=function(op_name,params){if(!this.enable)return;var _this=this;if(!_this.enable)return;var _method=_this.oper.cmd[op_name];if(typeof params=="string")tdevs.rpc(GUID(),_method,params);else{var _params=extend({},FastReport.DEFAULTS,params);tdevs.rpc(GUID(),_method,_params)}},FastReport.prototype.design=function(params){this.handle("design",params)},FastReport.prototype.preview=function(params){this.handle("preview",params)},FastReport.prototype.print=function(params){this.handle("print",params)},FastReport.prototype.exportdata=function(params){this.handle("export_data",params)},FastReport.prototype.init=function(url){var id=GUID(),_method=this.oper.cmd.seturl,_params=url;tdevs.rpc(id,_method,_params),this.url=url,this.inited=!0},FastReport.prototype.printerlist=function(callback){if(!this.enable)return;var id=GUID(),_method=this.oper.cmd.printerlist;regCallBack(id,_method,function(result){callback&&callback(result)}),tdevs.rpc(id,_method,{})},$window.FastReport=FastReport;var Version=function(){this.oper=Version.OPER};Version.OPER={cmd:{getversion:"tcsl.devicemgr.get_version"}},Version.prototype.getversion=function(callback){var id=GUID(),_method=this.oper.cmd.getversion;regCallBack(id,_method,function(result){callback&&callback(result)}),tdevs.rpc(id,_method,{})};var DevicePrint=function(url){url&&(this.url=url),this.oper=DevicePrint.OPER};DevicePrint.OPER={cmd:{preview:"tcsl.xlsprint.preview",print:"tcsl.xlsprint.print"}},DevicePrint.prototype.handle=function(url,oper){if(this.url||url){url=this.url;var id=GUID();tdevs.rpc(id,oper,url)}},DevicePrint.prototype.print=function(url){this.handle(url,this.oper.cmd.print)},DevicePrint.prototype.preview=function(url){this.handle(url,this.oper.cmd.preview)},$window.DevicePrint=DevicePrint;var CrmM1=function(enable){this.enable=enable,this.oper=CrmM1.OPER};CrmM1.DEFAULTS={mode:1,comport:1,comrate:"9600",pin:"000003"},CrmM1.OPER={cmd:{readno:"tcsl.cardop.read_no"}},CrmM1.prototype.handle=function(op_name,params,callback){if(!tdevs.isWin){this.enable=!1;return}var _this=this;if(!_this.enable)return;var _method=_this.oper.cmd[op_name],_params=extend({},CrmM1.DEFAULTS,params),id=GUID();callback&&regCallBack(id,_method,function(result){callback&&callback(result)}),tdevs.rpc(id,_method,_params)},CrmM1.prototype.readno=function(params,callback){this.handle("readno",params,callback)},$window.CrmM1=CrmM1;var socket,_callbak_keys=[],_callbak_funcs=[],regCallBack=function(id,cmd,func,data){_callbak_keys.push(id),_callbak_funcs.push({id:id,cmd:cmd,func:func,data:data})},findCallBack=function(id){for(var i=0;i<_callbak_keys.length;i++)if(_callbak_keys[i]==id)return _callbak_funcs[i];return null},findCallBacks=function(cmd){var funcs=[];for(var i=0;i<_callbak_funcs.length;i++)_callbak_funcs[i].cmd==cmd&&funcs.push(extend({},_callbak_funcs[i]));return funcs},_setting={location:"ws://127.0.0.1:5414",onerror:function(event){_setting.cuserr&&_setting.cuserr();if(_setting.errCallBack)_setting.errCallBack(),_setting.errCallBack=!1;else{if(event.message)typeof $!="undefined"?$.toast(event.message,{type:"danger"}):typeof tcsl!="undefined"&&tcsl.Toast.warn(event.message);else if(typeof $!="undefined")$.toast("设备连接失败",{type:"danger"});else if(typeof tcsl!="undefined"){var msg="设备连接失败";tdevs.curDmPackage&&(msg="设备管理器连接失败，如需并口打印、钱箱、客显，请启动设备管理器 <br/>如未安装请<a href ='"+tdevs.curDmPackage+"'>点击下载</a>"),tcsl.Msg.warn(msg)}tdevs.errShowed=!0}},onopen:function(event){_setting.cusopen&&_setting.cusopen(),_setting.initCallBack&&(_setting.initCallBack(),_setting.initCallBack=!1)},onsgcrpcresult:function(m){var result=obj.result,id=obj.id,funcObj=findCallBack(id);funcObj&&funcObj.func(obj.result,funcObj.data)}};this.opt=_setting,this.isReady=function(){return socket?socket.state()=="open":!1},this.isClose=function(){return socket.state()=="close"},this.rpc=function(id,method,params){if(this.notSupper)return;dlog("rpc params before :",params),typeof params=="object"&&(params=JSON.stringify(params)),params=Base64.encode(params),params='{"v":"'+params+'"}',dlog("rpc params after :",params);if(socket!=null&&tdevs.isReady())socket.rpc(id,method,params);else{var initCallBack=function(){socket.rpc(id,method,params)};this.initWS({initCallBack:initCallBack})}},this.setInitCallBack=function(fun){fun&&(_setting.initCallBack=fun)},this.initWS=function(opt,callback){if(!$window.WebSocket){this.notSupper=!0;return}if(!socket){var setting=getWsSetting(opt);socket=new sgcws(setting.location),setAttr(socket,setting)}else if(socket.state()=="closed"||socket.state()=="closing"){var setting=getWsSetting(opt);socket=new sgcws(setting.location),setAttr(socket,setting)}callback&&callback()}};return{init:function(){var me=this,isWin=!0;TDevices.isWin=isWin,this.rpt=new FastReport(!0);if(!isWin)return;var cfg={location:"ws://127.0.0.1:5414",initCallBack:function(){me.rpt.init("http://192.168.12.132:7001/cy7/"),me.rpt.printerlist(function(result){$rootScope.printers=[];var printers=result.message.list;for(var i in printers){var data={id:"",name:""};data.id=i,data.name=printers[i],$rootScope.printers.push(data)}console.log($rootScope.printers)})}};TDevices.initWS(cfg),TDevices.report=this.rpt},printhyz:function(){var printinfo={fileid:101,exporttype:1,printer:"report",printcnt:1,DS1:[{openedPeople:1,wipeMoney:1,presentMoney:1,psPOSAllName:1,openTime:"1409529600",unreturnedDeposit:1,cancelMoney:1,preUnsettledBillQty:1,saleTotal:1,invoiceMoney:1,origMoney:1,useedDeposit:1,preUnreturnedDeposit:1,discMoney:1,returnedDeposit:1,fillMinimumCharge:1,registerDeposit:1,settledBillQty:1,settledPeople:1,discFix:1,closeTime:"1409529600",operatorName:"韩英泽",psPOSId:1,preUnsettledMoney:1,itemTotalCharge:21,psPOSCode:1,revenueTotal:1,psPOSName:1,bsCode:1,openBillQty:1,pettyCash:1,serviceCharge:1,preUnsettledPeople:1,operatorTime:"1409529600",settledMoney:1,voidQty:1,payWayMoneyAndCouponMoney:1}],DS2:[{payMoney:1,payway:1,paywayName:1}],DS3:[{sumIncomeTotal:1,sumNotIncomeMoney:1,sumLastTotal:1}]};TDevices.report.design(printinfo)},print:function(printData){TDevices.report.print(printData)},design:function(printData){TDevices.report.design(printData)},exportData:function(printData){TDevices.report.exportdata(printData)},preview:function(printData){TDevices.report.preview(printData)}}}])});