define(["require","posService","pos/cardoperate/cancelbind/cancelCardBindCtrl","text!pos/cardoperate/cancelbind/cancelCardBind.html"],function(require){var posService=require("posService"),cancelCardBindCtrl=require("pos/cardoperate/cancelbind/cancelCardBindCtrl"),cancelCardBindTemp=require("text!pos/cardoperate/cancelbind/cancelCardBind.html");return["$scope","$uibModal","posService","ajaxService","register","getCookieService","appConstant","modalService","$rootScope","$timeout",function($scope,$uibModal,posService,ajaxService,register,getCookieService,appConstant,modalService,$rootScope,$timeout){var sessionId=getCookieService.getCookie("CRMSESSIONID");$scope.tipMsg={},$scope.relCard=0,$scope.eleCard=1;var sessionId=$rootScope.sessionId;$scope.birthdayTypeList=appConstant.birthdayTypeList,$scope.cardKindList=appConstant.cardKindList,$scope.nationList=appConstant.nationList,$scope.setFocus=function(eId){var setTimer=posService.setFocus(eId);$scope.$on("$destroy",function(){$timeout.cancel(setTimer)})},$scope.relCardSell={cardInfo:{mobile:"",cardNo:"",password:"",repassword:"",cardTypeInfo:"",cardTypeName:"",smsCode:"",mobileCopy:""},memberInfo:{name:"",sex:1,birthdayType:"0",birthday:null,byInviteCode:"",byInviteName:"",nation:"0",cardKind:"",certificateNo:"",workUnit:"",job:"",address:"",note:""},sellType:"1",isRegistered:!0,isValidCode:!1,isValidCardNo:!1,isValidInvite:!1,displayValidateCode:!1,displayCancelBind:!1,invalidCardNoInfo:"",sessionId:sessionId},$scope.allCardTypeList=[],$scope.allCardTypeList2=[],ajaxService.AjaxPost({sessionId:$rootScope.sessionId},"memberequity/cardtype/getCardTypeCombo.do").then(function(result){if(result.data){$scope.allCardTypeList=result.data,$scope.cardTypeList2=[];for(var i=0;i<result.data.length;i++){var oType=result.data[i],temp=oType.value+","+oType.cardCharge,cardTypeObj={value:temp,showName:oType.showName};$scope.allCardTypeList2.push(cardTypeObj)}$scope.relCardSell.cardInfo.cardTypeInfo=$scope.allCardTypeList2[0].value,$scope.eleCardSell.cardInfo.cardType=$scope.allCardTypeList[0].value}}),$scope.validatePasswd=function(sellCardType){var cardSellObj=null;$scope.eleCard==sellCardType?cardSellObj=$scope.eleCardSell:cardSellObj=$scope.relCardSell;var result=!1;return/^\d{6}$/.test(cardSellObj.cardInfo.repassword)?cardSellObj.cardInfo.repassword!=cardSellObj.cardInfo.password&&($scope.tipMsg.repassword="两次输入密码不一致！",result=!0):($scope.tipMsg.repassword="请输入6位数字密码！",result=!0),result},$scope.validateMobile=function(sellCardType){var cardSellObj=null;$scope.eleCard==sellCardType?cardSellObj=$scope.eleCardSell:cardSellObj=$scope.relCardSell;if(cardSellObj.cardInfo.mobileCopy==cardSellObj.cardInfo.mobile)return!1;cardSellObj.cardInfo.mobileCopy=cardSellObj.cardInfo.mobile,cardSellObj.isRegistered=!0,cardSellObj.isValidCode=!1,cardSellObj.cardInfo.smsCode="",cardSellObj.cardInfo.mobile&&cardSellObj.cardInfo.mobile!=""&&/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/.test(cardSellObj.cardInfo.mobile)?ajaxService.AjaxPost({mobile:cardSellObj.cardInfo.mobile,sessionId:sessionId},"postrade/posCardUsed/isMobileRegisted.do").then(function(result){result.isMobileRegisted?(cardSellObj.isRegistered=!0,cardSellObj.displayCancelBind=!0,cardSellObj.displayValidateCode=!1):(cardSellObj.isRegistered=!1,cardSellObj.displayValidateCode=!0,cardSellObj.displayCancelBind=!1)}):(cardSellObj.displayCancelBind=!1,cardSellObj.displayValidateCode=!1)},$scope.getSellCardSmsCode=function(sellCardType){var cardSellObj=null;$scope.eleCard==sellCardType?cardSellObj=$scope.eleCardSell:cardSellObj=$scope.relCardSell,cardSellObj.cardInfo.smsCode="",cardSellObj.isValidCode=!1,cardSellObj.cardInfo.mobile&&cardSellObj.cardInfo.mobile!=""&&/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/.test(cardSellObj.cardInfo.mobile)?ajaxService.AjaxPost({mobile:cardSellObj.cardInfo.mobile,sessionId:sessionId},"common/sms/getSmsCode.do").then(function(result){result.status&&modalService.info({content:"发送验证码成功！",type:"ok"})}):modalService.info({title:"提示",content:"请输入11位手机号！",size:"sm",type:"confirm"})},$scope.checkSellCardSmsCode=function(sellCardType){var cardSellObj=null;$scope.eleCard==sellCardType?cardSellObj=$scope.eleCardSell:cardSellObj=$scope.relCardSell,cardSellObj.isValidCode=!1;if(cardSellObj.cardInfo.smsCode&&cardSellObj.cardInfo.smsCode!=""){var param={smsCode:cardSellObj.cardInfo.smsCode,mobile:cardSellObj.cardInfo.mobile,sessionId:sessionId};ajaxService.AjaxPost(param,"common/sms/checkSmsCode.do").then(function(result){result.status&&result.smsCodeStatus&&(cardSellObj.isValidCode=!0)})}},$scope.checkCardNo=function(){$scope.relCardSell.isValidCardNo=!1,$scope.relCardSell.invalidCardNoInfo="",$scope.relCardSell.cardInfo.cardNo&&$scope.relCardSell.cardInfo.cardNo!=""&&/^[1-9](\d{4,9}|\d{11,15})$/.test($scope.relCardSell.cardInfo.cardNo)&&ajaxService.AjaxPost({cardNo:$scope.relCardSell.cardInfo.cardNo,sessionId:sessionId},"postrade/posCardUsed/isCardUnsaled.do").then(function(result){result&&(result.cardNoStatus?($scope.relCardSell.isValidCardNo=!0,$scope.relCardSell.cardInfo.cardTypeInfo=result.data.cardTypeId+","+result.data.cardCharge):$scope.relCardSell.invalidCardNoInfo=result.errCardNoMsg)})},$scope.checkByInviteCode=function(sellCardType){var cardSellObj=null;$scope.eleCard==sellCardType?cardSellObj=$scope.eleCardSell:cardSellObj=$scope.relCardSell,cardSellObj.isValidInvite=!1,cardSellObj.memberInfo.byInviteCode&&cardSellObj.memberInfo.byInviteCode!=""&&/^[0-9A-Z]{6}$/.test(cardSellObj.memberInfo.byInviteCode)?ajaxService.AjaxPost({byInviteCode:cardSellObj.memberInfo.byInviteCode,sessionId:sessionId},"postrade/posMember/checkMemberByInviteCode.do").then(function(result){result.status?(cardSellObj.isValidInvite=!0,cardSellObj.memberInfo.byInviteName=result.byInviteName):cardSellObj.memberInfo.byInviteName=""},function(data){cardSellObj.memberInfo.byInviteName=""}):cardSellObj.memberInfo.byInviteName=""},$scope.saveRelSellCard=function(){if($scope.relCardSell.cardInfo.mobile&&$scope.relCardSell.cardInfo.mobile!=""){if(!/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/.test($scope.relCardSell.cardInfo.mobile))return modalService.info({title:"提示",content:"请输入11位手机号!",size:"sm",type:"confirm"}),!1;if($scope.relCardSell.isRegistered)return modalService.info({title:"提示",content:"该手机号已和其它会员卡绑定，无法办新卡！",size:"sm",type:"confirm"}),!1;if(!$scope.relCardSell.isValidCode)return modalService.info({title:"提示",content:"请输入验证码验证手机号！",size:"sm",type:"confirm"}),!1}if(!$scope.relCardSell.cardInfo.cardNo||$scope.relCardSell.cardInfo.cardNo=="")return modalService.info({title:"提示",content:"请读取或输入卡号！",size:"sm",type:"confirm"}),!1;if(!$scope.relCardSell.isValidCardNo)return modalService.info({title:"提示",content:"会员卡不存在或已被出售！",size:"sm",type:"confirm"}),!1;if(!/^\d{6}$/.test($scope.relCardSell.cardInfo.password))return modalService.info({title:"提示",content:"请输入6位密码！",size:"sm",type:"confirm"}),!1;if(!/^\d{6}$/.test($scope.relCardSell.cardInfo.repassword))return modalService.info({title:"提示",content:"请输入6位确认密码！",size:"sm",type:"confirm"}),!1;if($scope.relCardSell.cardInfo.repassword!=$scope.relCardSell.cardInfo.password)return modalService.info({title:"提示",content:"两次输入的密码不一致！",size:"sm",type:"confirm"}),!1;if(!$scope.relCardSell.memberInfo.birthday)return modalService.info({title:"提示",content:"请选择生日！",size:"sm",type:"confirm"}),!1;if($scope.relCardSell.memberInfo.cardKind&&$scope.relCardSell.memberInfo.cardKind!=""&&(!$scope.relCardSell.memberInfo.certificateNo||$scope.relCardSell.memberInfo.certificateNo==""))return modalService.info({title:"提示",content:"请填写证件编号！",size:"sm",type:"confirm"}),!1;if($scope.relCardSell.memberInfo.certificateNo&&$scope.relCardSell.memberInfo.certificateNo!=""&&(!$scope.relCardSell.memberInfo.cardKind||$scope.relCardSell.memberInfo.cardKind==""))return modalService.info({title:"提示",content:"请选择证照类型！",size:"sm",type:"confirm"}),!1;if($scope.relCardSell.memberInfo.byInviteCode&&$scope.relCardSell.memberInfo.byInviteCode!=""&&!$scope.relCardSell.isValidInvite)return modalService.info({title:"提示",content:"请填写有效的邀请码！",size:"sm",type:"confirm"}),!1;$scope.relCardSell.memberInfo.birthday=(new Date($scope.relCardSell.memberInfo.birthday)).getTime(),$scope.relCardSell.cardInfo.cardTypeName=$("#cardType").find("option:selected").text(),ajaxService.AjaxPost($scope.relCardSell,"postrade/posCardUsed/saveSellCard.do").then(function(result){result.status&&(modalService.info({content:"售卡成功！",type:"ok"}),posService.goBack())})},$scope.cancelBindCard=function(sellCardType){var cardSellObj=null;$scope.eleCard==sellCardType?cardSellObj=$scope.eleCardSell:cardSellObj=$scope.relCardSell,showCancelCardBindModal(cardSellObj)};var showCancelCardBindModal=function(cardSellObj){var modalInstance=$uibModal.open({animation:!0,template:cancelCardBindTemp,size:"lg",controller:"cancelCardBindCtrl",resolve:{cancelBindModal:function(){var param={mobile:cardSellObj.cardInfo.mobile};return param}}});modalInstance.result.then(function(cancelResult){cancelResult.status&&(cardSellObj.isRegistered=!1,cardSellObj.isValidCode=!1,cardSellObj.displayCancelBind=!1,cardSellObj.displayValidateCode=!0,modalService.info({content:"解除绑定成功!",type:"ok"}))})};$scope.cancel=function(){posService.goBack()},$scope.eleCardSell={cardInfo:{mobile:"",cardType:"",cardNo:"",password:"",repassword:"",cardTypeName:"",smsCode:"",cardCharge:0,mobileCopy:""},memberInfo:{name:"",sex:1,birthdayType:"0",birthday:null,byInviteCode:"",byInviteName:"",nation:"0",cardKind:"",certificateNo:"",workUnit:"",job:"",address:"",note:""},sellType:"2",isRegistered:!0,isValidCode:!1,isValidCardNo:!0,isValidInvite:!1,displayValidateCode:!1,displayCancelBind:!1,invalidCardNoInfo:"",sessionId:sessionId},$scope.getCardNoAndTypeInfo=function(cardInfo){cardInfo.cardCharge=0,cardInfo.cardNo="",cardInfo.cardType&&ajaxService.AjaxPost({cardType:cardInfo.cardType,sessionId:sessionId},"postrade/posCardUsed/getCardNoAndTypeInfo.do").then(function(result){result.status&&(cardInfo.cardCharge=result.cardCharge,cardInfo.cardNo=result.cardNo)})},$scope.changeElectronicTab=function(){$scope.getCardNoAndTypeInfo($scope.eleCardSell.cardInfo)},$scope.saveEelSellCard=function(){if(!$scope.eleCardSell.cardInfo.mobile||$scope.eleCardSell.cardInfo.mobile=="")return modalService.info({title:"提示",content:"手机号码不允许为空!",size:"sm",type:"confirm"}),!1;if(!/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/.test($scope.eleCardSell.cardInfo.mobile))return modalService.info({title:"提示",content:"请输入11位手机号!",size:"sm",type:"confirm"}),!1;if($scope.eleCardSell.isRegistered)return modalService.info({title:"提示",content:"该手机号已和其它会员卡绑定，无法办新卡！",size:"sm",type:"confirm"}),!1;if(!$scope.eleCardSell.isValidCode)return modalService.info({title:"提示",content:"请输入验证码验证手机号！",size:"sm",type:"confirm"}),!1;if(!$scope.eleCardSell.cardInfo.cardNo||$scope.eleCardSell.cardInfo.cardNo=="")return modalService.info({title:"提示",content:"不能获取卡号，请核实！",size:"sm",type:"confirm"}),!1;if(!/^\d{6}$/.test($scope.eleCardSell.cardInfo.password))return modalService.info({title:"提示",content:"请输入6位密码！",size:"sm",type:"confirm"}),!1;if(!/^\d{6}$/.test($scope.eleCardSell.cardInfo.repassword))return modalService.info({title:"提示",content:"请输入6位确认密码！",size:"sm",type:"confirm"}),!1;if($scope.eleCardSell.cardInfo.repassword!=$scope.eleCardSell.cardInfo.password)return modalService.info({title:"提示",content:"两次输入的密码不一致！",size:"sm",type:"confirm"}),!1;if(!$scope.eleCardSell.memberInfo.birthday)return modalService.info({title:"提示",content:"请选择生日！",size:"sm",type:"confirm"}),!1;if($scope.eleCardSell.memberInfo.cardKind&&$scope.eleCardSell.memberInfo.cardKind!=""&&(!$scope.eleCardSell.memberInfo.certificateNo||$scope.eleCardSell.memberInfo.certificateNo==""))return modalService.info({title:"提示",content:"请填写证件编号！",size:"sm",type:"confirm"}),!1;if($scope.eleCardSell.memberInfo.certificateNo&&$scope.eleCardSell.memberInfo.certificateNo!=""&&(!$scope.eleCardSell.memberInfo.cardKind||$scope.eleCardSell.memberInfo.cardKind==""))return modalService.info({title:"提示",content:"请选择证照类型！",size:"sm",type:"confirm"}),!1;if($scope.eleCardSell.memberInfo.byInviteCode&&$scope.eleCardSell.memberInfo.byInviteCode!=""&&!$scope.eleCardSell.isValidInvite)return modalService.info({title:"提示",content:"请填写有效的邀请码！",size:"sm",type:"confirm"}),!1;$scope.eleCardSell.memberInfo.birthday=(new Date($scope.eleCardSell.memberInfo.birthday)).getTime(),ajaxService.AjaxPost($scope.eleCardSell,"postrade/posCardUsed/saveSellCard.do").then(function(result){result.status&&(modalService.info({content:"售卡成功！",type:"ok"}),posService.goBack())})}}]});