define(["posService"],function(){var angular=require("angular");return["$scope","$window","ajaxService","posService","getCookieService","$rootScope","modalService","$filter","$uibModal","$state",function($scope,$window,ajaxService,posService,getCookieService,$rootScope,modalService,$filter,$uibModal,$state){var sessionId=getCookieService.getCookie("CRMSESSIONID");$scope.changeCardVo={oldCardNo:"",newCardNo:"",password:"",repassword:"",memberHomeBean:"",sessionId:$rootScope.sessionId,verifyOldPass:"",cardChargeType:1},$scope.newCardInfo={},$scope.validatePasswdMsg="请输入6位数字密码",$scope.validatePasswd=function(){$scope.validatePasswdMsg="";if(!/^\d{6}$/.test($scope.changeCardVo.repassword)||$scope.changeCardVo.repassword==""){$scope.validatePasswdMsg="请输入6位数字密码",$scope.validatePasswdresult=!0;return}if($scope.changeCardVo.repassword!=$scope.changeCardVo.password){$scope.validatePasswdMsg="两次输入密码不一致！",$scope.validatePasswdresult=!0;return}$scope.validatePasswdresult=!1},$scope.isValidCardNo=!1,$scope.verifyNewCard=function(newCardNo){newCardNo&&newCardNo!=""&&/^[1-9](\d{4,9}|\d{11,15})$/.test(newCardNo)&&ajaxService.AjaxPost({cardNo:newCardNo,sessionId:sessionId},"postrade/posCardUsed/isCardUnsaled.do").then(function(result){result&&(result.cardNoStatus?($scope.invalidCardNoInfo="",$scope.isValidCardNo=!1,$scope.newCardInfo=result.data):($scope.isValidCardNo=!0,$scope.invalidCardNoInfo=result.errCardNoMsg))})},$rootScope.currentuserinfo&&($scope.entranceFrom=1,$scope.currUserInfo=angular.copy($rootScope.currentuserinfo),$scope.changeCardVo.oldCardNo=$scope.currUserInfo.cardInfoBean.number,$scope.oldCardNoDisabled=!0,$scope.currUserInfo.cardInfoBean.cardStatus!==101&&($scope.isOldCardStatus=!0)),$scope.getMemeberAndCardInfo=function(){$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null;if(!$scope.changeCardVo.oldCardNo||$scope.changeCardVo.oldCardNo==""||!/^(([1-9](\d{4,9}|\d{11,15})))$/.test($scope.changeCardVo.oldCardNo))return;ajaxService.AjaxPost({paramValue:$scope.changeCardVo.oldCardNo,sessionId:sessionId},"postrade/memberhome/memberhomeinfo.do").then(function(result){if(result.status&&result.data){var data=result.data;$rootScope.cardoperatetoeditusrmemberinfo=data.memberInfoBean,$rootScope.currentuserinfo=data,$scope.oldCardNoDisabled=!0,data.cardInfoBean.cardStatus!==101&&($scope.isOldCardStatus=!0),$scope.entranceFrom=0,$scope.currUserInfo=data}})},$scope.goBack=function(){$scope.entranceFrom==0&&($rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null),posService.goBack()},$scope.saveChangeCard=function(changeCardVo){var html=["<div>",'			<div class="modal-header">',"				请输入原卡密码",'			<i class="iconfont" style="float:right;" ng-click="cancelVerifyOldPass()">&#xe63c;</i>',"			</div>",'		    <div class="modal-body">','			    <form class="form-horizontal" autocomplete="off" name="veryifyOldPassForm" id="veryifyOldPassForm" ng-submit="veryifyOldPass()">','			         <div class="form-group">','		                  <input type="password" class="form-control  form-control-input consume-text-size" ','		                  			name="oldPass" id="oldPass" placeholder="请输入6位数字密码,不输入默认6个1"','		                           ng-model="veryifyOldPassVo.oldPass"','		                           ng-pattern="/^\\d{6}$|^$/"','		                           tooltip-trigger="blur" ',"		                           uib-tooltip=\"{{veryifyOldPassForm.oldPass.$invalid ?'请输入6位数字密码':''}}\"",'		                           tooltip-placement="bottom"/>',"            		</div>",'		            <div class="modal-footer">','				        <div class="col-sm-6">','				            <button type="submit"  class="btn btn-primary btn-default pos-btn" ng-disabled="veryifyOldPassForm.oldPass.$invalid">确定(Enter)</button>',"				        </div>",'				        <div class="col-sm-6">','				            <button type="button"  class="btn btn-default pos-btn" ng-click="cancelVerifyOldPass()">取消(Esc)</button>',"				        </div>","				   </div>","		   	</form>","          </div>","		</div>"].join(""),modalInstance=$uibModal.open({animation:!0,template:html,size:"sm",resolve:{ModelParamData:function(){return changeCardVo}},controller:["$scope","$rootScope","$uibModalInstance","$state","ajaxService","ModelParamData",function($scope,$rootScope,$uibModalInstance,$state,ajaxService,ModelParamData){$scope.veryifyOldPassVo={oldPass:""},$scope.veryifyOldPass=function(){var flag=!1,oldcardNo=ModelParamData.oldCardNo,vpass=$scope.veryifyOldPassVo.oldPass==""?111111:$scope.veryifyOldPassVo.oldPass,param={oldCardNo:oldcardNo,sessionId:$rootScope.sessionId,verifyOldPass:vpass};ajaxService.AjaxPost(param,"postrade/card/verifyCardPass.do").then(function(result){result.status&&(flag=!0),$uibModalInstance.close(flag)})},$scope.cancelVerifyOldPass=function(){$uibModalInstance.dismiss("cancel")}}]});modalInstance.result.then(function(veryifyStatus){if(veryifyStatus&&$scope.newCardInfo&&veryifyStatus){var param={oldCardNo:$scope.changeCardVo.oldCardNo,password:$scope.changeCardVo.password,repassword:$scope.changeCardVo.repassword,memberHomeBean:$scope.currUserInfo,posCardUnsaled:$scope.newCardInfo,sessionId:$rootScope.sessionId,cardChargeType:$scope.changeCardVo.cardChargeType};ajaxService.AjaxPost(param,"postrade/card/changeCard.do").then(function(result){result.status===1&&(modalService.info({content:"成功!",type:"ok"}),ajaxService.AjaxPost({paramValue:$scope.newCardInfo.number,sessionId:sessionId},"postrade/memberhome/memberhomeinfo.do").then(function(result){if(result.status&&result.data){var data=result.data;$rootScope.cardoperatetoeditusrmemberinfo=data.memberInfoBean,$rootScope.currentuserinfo=data}}),$state.go("pos.cardoperte.mainpage"))})}})}}]});