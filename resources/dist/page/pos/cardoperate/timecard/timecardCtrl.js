define(["require","angular","posService","pos/cardoperate/poppasswd/poppasswdCtrl","text!pos/cardoperate/poppasswd/poppasswd.html"],function(require){var angular=require("angular"),posService=require("posService"),poppasswdCtrl=require("pos/cardoperate/poppasswd/poppasswdCtrl"),poppasswdTemp=require("text!pos/cardoperate/poppasswd/poppasswd.html");return["$scope","$window","ajaxService","posService","getCookieService","$rootScope","modalService","$uibModal","$filter","$timeout",function($scope,$window,ajaxService,posService,getCookieService,$rootScope,modalService,$uibModal,$filter,$timeout){function trueSave(){ajaxService.AjaxPost($scope.rechargeVo,"postrade/timeCard/saveRechargeTime.do").then(function(result){$scope.rechargeVo.forbideSave=!1,result.status&&(modalService.info({content:"充值次数成功!",type:"ok"}),console.log(result.printInfo),$scope.entranceFrom==0?($scope.rechargeVo={cardNo:"",time:"",tsCode:0,tsTypeId:2,tsTypeName:"现金",value:"",timeBalance:0,sessionId:sessionId,isValidTimeAccount:!1,forbideSave:!1},$scope.consumeVo={cardNo:"",time:"",tsCode:0,timeBalance:0,sessionId:sessionId,isValidTimeAccount:!1,forbideSave:!1},$scope.cardNoDisabled=!1,$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null):($scope.getMemeberAndCardInfo($scope.rechargeTimeOper),posService.goBack()))},function(){$scope.rechargeVo.forbideSave=!1})}function checkConsumeTsCode(){$scope.consumeVo.tsCode?trueSave2():ajaxService.AjaxPost({sessionId:sessionId},"postrade/postscode/generatorTsCode.do").then(function(result){result.tsCode?($scope.consumeVo.tsCode=result.tsCode,trueSave2()):$scope.consumeVo.forbideSave=!1},function(){$scope.consumeVo.forbideSave=!1})}function trueSave2(){ajaxService.AjaxPost($scope.consumeVo,"postrade/timeCard/saveConsumeTime.do").then(function(result){$scope.consumeVo.forbideSave=!1,result.status&&(modalService.info({content:"消费次数成功!",type:"ok"}),console.log(result.printInfo),$scope.entranceFrom==0?($scope.rechargeVo={cardNo:"",time:"",tsCode:0,tsTypeId:2,tsTypeName:"现金",value:"",timeBalance:0,sessionId:sessionId,isValidTimeAccount:!1,forbideSave:!1},$scope.consumeVo={cardNo:"",time:"",tsCode:0,timeBalance:0,sessionId:sessionId,isValidTimeAccount:!1,forbideSave:!1,password:""},$scope.cardNoDisabled=!1,$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null):($scope.getMemeberAndCardInfo($scope.cosumeTimeOper),posService.goBack()))},function(){$scope.consumeVo.forbideSave=!1})}var sessionId=getCookieService.getCookie("CRMSESSIONID");$scope.rechargeTimeOper=1,$scope.cosumeTimeOper=2,$scope.entranceFrom=0,$scope.cardNoDisabled=!1,$scope.rechargeVo={cardNo:"",time:"",tsCode:0,tsTypeId:2,tsTypeName:"现金",value:"",timeBalance:0,sessionId:sessionId,isValidTimeAccount:!1,forbideSave:!1},$scope.consumeVo={cardNo:"",time:"",tsCode:0,timeBalance:0,sessionId:sessionId,isValidTimeAccount:!1,forbideSave:!1},$scope.setFocus=function(eId){var setTimer=posService.setFocus(eId);$scope.$on("$destroy",function(){$timeout.cancel(setTimer)})},$scope.getTimeAccountInfo=function(cardNo){ajaxService.AjaxPost({cardNo:cardNo,sessionId:sessionId},"postrade/posCardAccount/getTimeAccount.do").then(function(result){result.status&&($scope.consumeVo.timeBalance=result.timeBalance,$scope.consumeVo.isValidTimeAccount=!0,$scope.rechargeVo.timeBalance=result.timeBalance,$scope.rechargeVo.isValidTimeAccount=!0)})},$scope.getMemeberAndCardInfo=function(operationType){var timeVo=null;$scope.rechargeTimeOper==operationType?timeVo=$scope.rechargeVo:timeVo=$scope.consumeVo,$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null,$scope.consumeVo.timeBalance=0,$scope.consumeVo.isValidTimeAccount=!1,$scope.rechargeVo.timeBalance=0,$scope.rechargeVo.isValidTimeAccount=!1;if(!timeVo.cardNo||timeVo.cardNo==""||!/^(((13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8})|([1-9](\d{4,9}|\d{11,15})))$/.test(timeVo.cardNo))return!1;ajaxService.AjaxPost({paramValue:timeVo.cardNo,sessionId:sessionId},"postrade/memberhome/memberhomeinfo.do").then(function(result){if(result.status&&result.data){var data=result.data;$rootScope.cardoperatetoeditusrmemberinfo=data.memberInfoBean,$rootScope.currentuserinfo=data,$scope.currUserInfo=$rootScope.currentuserinfo,$scope.rechargeVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.consumeVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.getTimeAccountInfo($scope.currUserInfo.cardInfoBean.number)}})},$rootScope.currentuserinfo&&($scope.entranceFrom=1,$scope.currUserInfo=$rootScope.currentuserinfo,$scope.rechargeVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.consumeVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.cardNoDisabled=!0,$scope.getTimeAccountInfo($scope.currUserInfo.cardInfoBean.number)),$scope.tsTypeList=[],ajaxService.AjaxPost({sessionId:sessionId},"postrade/tstype/getPosTsType.do").then(function(result){$scope.tsTypeList=result.data}),$scope.changeTsType=function(tsType){$scope.rechargeVo.tsTypeId=tsType.id,$scope.rechargeVo.tsTypeName=tsType.name},$scope.saveRecharge=function(){$scope.rechargeVo.forbideSave=!0;if(!$scope.rechargeVo.cardNo||$scope.rechargeVo.cardNo==""||!/[1-9](?:\d{0,9}|\d{11,15})/.test($scope.rechargeVo.cardNo))return modalService.info({title:"提示",content:"获取不到正确卡号!",size:"sm",type:"confirm"}),$scope.rechargeVo.forbideSave=!1,!1;if(!$scope.rechargeVo.isValidTimeAccount)return modalService.info({title:"提示",content:"未发现有效的次数账户!",size:"sm",type:"confirm"}),$scope.rechargeVo.forbideSave=!1,!1;if(!$scope.rechargeVo.time||$scope.rechargeVo.time==""||!/^[1-9]\d{0,6}$/.test($scope.rechargeVo.time))return modalService.info({title:"提示",content:"请输入合法充值次数!",size:"sm",type:"confirm"}),$scope.rechargeVo.forbideSave=!1,!1;if(!$scope.rechargeVo.value||$scope.rechargeVo.value==""||!/^[1-9]\d{0,6}(?:\.\d{1,2})?$/.test($scope.rechargeVo.value))return modalService.info({title:"提示",content:"请输入合法支付金额!",size:"sm",type:"confirm"}),$scope.rechargeVo.forbideSave=!1,!1;if(!$scope.rechargeVo.tsTypeId||!$scope.rechargeVo.tsTypeName||$scope.rechargeVo.tsTypeName=="")return modalService.info({title:"提示",content:"请选择支付方式!",size:"sm",type:"confirm"}),$scope.rechargeVo.forbideSave=!1,!1;$scope.rechargeVo.tsCode?trueSave():ajaxService.AjaxPost({sessionId:sessionId},"postrade/postscode/generatorTsCode.do").then(function(result){result.tsCode?($scope.rechargeVo.tsCode=result.tsCode,trueSave()):$scope.rechargeVo.forbideSave=!1},function(){$scope.rechargeVo.forbideSave=!1})},$scope.saveConsume=function(){$scope.consumeVo.forbideSave=!0;if(!$scope.consumeVo.cardNo||$scope.consumeVo.cardNo==""||!/[1-9](?:\d{0,9}|\d{11,15})/.test($scope.consumeVo.cardNo))return modalService.info({title:"提示",content:"获取不到正确卡号!",size:"sm",type:"confirm"}),$scope.consumeVo.forbideSave=!1,!1;if(!$scope.consumeVo.isValidTimeAccount)return modalService.info({title:"提示",content:"未发现有效的次数账户!",size:"sm",type:"confirm"}),$scope.consumeVo.forbideSave=!1,!1;if(!$scope.consumeVo.time||$scope.consumeVo.time==""||!/^[1-9]\d{0,6}$/.test($scope.consumeVo.time))return modalService.info({title:"提示",content:"请输入消费次数!",size:"sm",type:"confirm"}),$scope.consumeVo.forbideSave=!1,!1;if($scope.consumeVo.time>$scope.consumeVo.timeBalance)return modalService.info({title:"提示",content:"消费余额不足!",size:"sm",type:"confirm"}),$scope.consumeVo.forbideSave=!1,!1;poppasswdModal()},$scope.goBack=function(){$scope.entranceFrom==0&&($rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null),posService.goBack()},$scope.getPaymentUrl=function(typeName){return $filter("tranPaymentMethodIconSrc")(typeName)};var poppasswdModal=function(){var modalInstance=$uibModal.open({animation:!0,template:poppasswdTemp,size:"sm",controller:"poppasswdCtrl",resolve:{}});modalInstance.result.then(function(popPasswd){$scope.consumeVo.password=popPasswd.password,checkConsumeTsCode()},function(data){$scope.consumeVo.forbideSave=!1})}}]});