define(["posService"],function(){var angular=require("angular");return["$scope","$window","ajaxService","posService","getCookieService","$rootScope","modalService","$filter","devicesService",function($scope,$window,ajaxService,posService,getCookieService,$rootScope,modalService,$filter,devicesService){function trueSave(){ajaxService.AjaxPost($scope.rechargeVo,"postrade/recharge/rechargeMoney.do").then(function(result){$scope.forbideSave=!1;if(result.status){modalService.info({content:"充值成功!",type:"ok"}),console.log(result.printInfo);var data={businessType:1,printSetInfosBeans:$rootScope.printSetInfos,dataPkgObj:$scope.rechargeVo.tsCode,sessionId:$rootScope.sessionId};ajaxService.AjaxPost(data,"pos/print/printBill.do").then(function(result){result.status===1&&devicesService.design(result.data)}),$scope.entranceFrom==0?($scope.rechargeVo={cardNo:"",tsCode:0,tsTypeId:2,tsTypeName:"现金",value:"",sessionId:sessionId},$scope.cardNoDisabled=!1,$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null):($scope.getMemeberAndCardInfo(),posService.goBack())}},function(){$scope.forbideSave=!1})}var sessionId=getCookieService.getCookie("CRMSESSIONID");$scope.entranceFrom=0,$scope.cardNoDisabled=!1,$scope.forbideSave=!1,$scope.rechargeVo={cardNo:"",tsCode:0,tsTypeId:2,tsTypeName:"现金",value:"",sessionId:sessionId},$scope.getMemeberAndCardInfo=function(){$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null;if(!$scope.rechargeVo.cardNo||$scope.rechargeVo.cardNo==""||!/^(((13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8})|([1-9](\d{4,9}|\d{11,15})))$/.test($scope.rechargeVo.cardNo))return!1;ajaxService.AjaxPost({paramValue:$scope.rechargeVo.cardNo,sessionId:sessionId},"postrade/memberhome/memberhomeinfo.do").then(function(result){if(result.status&&result.data){var data=result.data;$rootScope.cardoperatetoeditusrmemberinfo=data.memberInfoBean,$rootScope.currentuserinfo=data,$scope.currUserInfo=$rootScope.currentuserinfo,$scope.rechargeVo.cardNo=$scope.currUserInfo.cardInfoBean.number}})},$rootScope.currentuserinfo&&($scope.entranceFrom=1,$scope.currUserInfo=$rootScope.currentuserinfo,$scope.rechargeVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.cardNoDisabled=!0),$scope.tsTypeList=[],ajaxService.AjaxPost({sessionId:sessionId},"postrade/tstype/getPosTsType.do").then(function(result){$scope.tsTypeList=result.data}),$scope.changeTsType=function(tsType){$scope.rechargeVo.tsTypeId=tsType.id,$scope.rechargeVo.tsTypeName=tsType.name},$scope.getTsCode=function(){$scope.rechargeVo.tsCode||ajaxService.AjaxPost({sessionId:sessionId},"postrade/postscode/generatorTsCode.do").then(function(result){$scope.rechargeVo.tsCode=result.tsCode})},$scope.saveRecharge=function(){$scope.forbideSave=!0;if(!$scope.rechargeVo.cardNo||$scope.rechargeVo.cardNo==""||!/[1-9](?:\d{0,9}|\d{11,15})/.test($scope.rechargeVo.cardNo))return modalService.info({title:"提示",content:"获取不到正确卡号!",size:"sm",type:"confirm"}),$scope.forbideSave=!1,!1;if(!$scope.rechargeVo.value||$scope.rechargeVo.value==""||!/^[1-9]\d{0,6}(?:\.\d{1,2})?$/.test($scope.rechargeVo.value))return modalService.info({title:"提示",content:"请输入合法支付金额!",size:"sm",type:"confirm"}),$scope.forbideSave=!1,!1;if(!$scope.rechargeVo.tsTypeId||!$scope.rechargeVo.tsTypeName||$scope.rechargeVo.tsTypeName=="")return modalService.info({title:"提示",content:"请选择支付方式!",size:"sm",type:"confirm"}),$scope.forbideSave=!1,!1;$scope.rechargeVo.tsCode?trueSave():ajaxService.AjaxPost({sessionId:sessionId},"postrade/postscode/generatorTsCode.do").then(function(result){result.tsCode?($scope.rechargeVo.tsCode=result.tsCode,trueSave()):$scope.forbideSave=!1},function(){$scope.forbideSave=!1})},$scope.goBack=function(){$scope.entranceFrom==0&&($rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null),posService.goBack()},$scope.getPaymentUrl=function(typeName){return $filter("tranPaymentMethodIconSrc")(typeName)}}]});