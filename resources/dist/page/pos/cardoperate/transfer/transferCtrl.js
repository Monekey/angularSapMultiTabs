define(["require","angular","posService","pos/cardoperate/poppasswd/poppasswdCtrl","text!pos/cardoperate/poppasswd/poppasswd.html"],function(require){var angular=require("angular"),posService=require("posService"),poppasswdCtrl=require("pos/cardoperate/poppasswd/poppasswdCtrl"),poppasswdTemp=require("text!pos/cardoperate/poppasswd/poppasswd.html");return["$scope","$window","ajaxService","posService","getCookieService","$rootScope","modalService","$uibModal",function($scope,$window,ajaxService,posService,getCookieService,$rootScope,modalService,$uibModal){function trueSave(){ajaxService.AjaxPost($scope.transferVo,"postrade/transfer/doTransfer.do").then(function(result){result.status&&(modalService.info({content:"转账成功!",type:"ok"}),$scope.flg.isContinue?($scope.transferVo={sessionId:sessionId,tsCode:null,tsCodes:null,outCardNo:null,inCardNo:null,value:null,type:0},$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null):($scope.getMemeberAndCardInfo(),$scope.goBack())),$scope.flg.isSave=!0})}var sessionId=getCookieService.getCookie("CRMSESSIONID");$scope.transferVo={sessionId:sessionId,tsCode:null,tsCodes:null,outCardNo:null,inCardNo:null,value:null,pwd:null,type:0},$scope.changeType=function(type){$scope.transferVo.type=type,$scope.transferVo.value=null},$scope.flg={isCardNo:!0,isContinue:!0,isSave:!0},$scope.getMemeberAndCardInfo=function(){$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null,!!$scope.transferVo.outCardNo&&$scope.transferVo.outCardNo!=""&&!!/^(((13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8})|([1-9](\d{4,9}|\d{11,15})))$/.test($scope.transferVo.outCardNo)&&ajaxService.AjaxPost({paramValue:$scope.transferVo.outCardNo,sessionId:sessionId},"postrade/memberhome/memberhomeinfo.do").then(function(result){if(result.data!==null){var data=result.data;$rootScope.cardoperatetoeditusrmemberinfo=data.memberInfoBean,$rootScope.currentuserinfo=data,$scope.currUserInfo=angular.copy($rootScope.currentuserinfo),$scope.transferVo.outCardNo=$scope.currUserInfo.cardInfoBean.number}else $rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null})},$rootScope.currentuserinfo&&($scope.flg.isContinue=!1,$scope.flg.isCardNo=!1,$scope.currUserInfo=$rootScope.currentuserinfo,$scope.transferVo.outCardNo=$scope.currUserInfo.cardInfoBean.number),$scope.doTransfer=function(){if(!$scope.flg.isSave)return!1;$scope.flg.isSave=!1,poppasswdModal()};var poppasswdModal=function(){var modalInstance=$uibModal.open({animation:!0,template:poppasswdTemp,size:"sm",controller:"poppasswdCtrl",resolve:{}});modalInstance.result.then(function(popPasswd){$scope.transferVo.pwd=popPasswd.password,$scope.transferVo.tscode?trueSave():ajaxService.AjaxPost({sessionId:sessionId,tsCount:2},"postrade/postscode/generatorTsCode.do").then(function(result){$scope.transferVo.tsCode=result.tsCode,$scope.transferVo.tsCodes=result.tsCodes,trueSave()})},function(data){$scope.flg.isSave=!0})};$scope.goBack=function(){posService.goBack()}}]});