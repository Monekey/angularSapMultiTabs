define(["posService"],function(){var angular=require("angular");return["$scope","$window","ajaxService","posService","getCookieService","$rootScope","modalService","$timeout",function($scope,$window,ajaxService,posService,getCookieService,$rootScope,modalService,$timeout){function trueSave(){ajaxService.AjaxPost($scope.editPasswdVo,"postrade/posCardUsed/saveEditPasswd.do").then(function(result){$scope.editPasswdVo.forbideSave=!1,result.status&&(modalService.info({content:"修改密码成功!",type:"ok"}),$scope.entranceFrom==0?($scope.editPasswdVo={cardNo:"",tsCode:"",oldPasswd:"",newPasswd:"",rePasswd:"",isValidNewPasswd:!1,sessionId:sessionId,forbideSave:!1},$scope.resetPasswdVo={cardNo:"",tsCode:"",sessionId:sessionId,forbideSave:!1},$scope.cardNoDisabled=!1,$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null):($scope.getMemeberAndCardInfo($scope.editPasswdVo.cardNo),posService.goBack()))},function(){$scope.editPasswdVo.forbideSave=!1})}function trueSave2(){ajaxService.AjaxPost($scope.resetPasswdVo,"postrade/posCardUsed/saveResetPasswd.do").then(function(result){$scope.resetPasswdVo.forbideSave=!1,result.status&&(modalService.info({content:"重置密码成功!",type:"ok"}),$scope.entranceFrom==0?($scope.editPasswdVo={cardNo:"",tsCode:"",oldPasswd:"",newPasswd:"",rePasswd:"",isValidNewPasswd:!1,sessionId:sessionId,forbideSave:!1},$scope.resetPasswdVo={cardNo:"",tsCode:"",sessionId:sessionId,forbideSave:!1},$scope.cardNoDisabled=!1,$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null):($scope.getMemeberAndCardInfo($scope.resetPasswdVo.cardNo),posService.goBack()))},function(){$scope.editPasswdVo.forbideSave=!1})}var sessionId=getCookieService.getCookie("CRMSESSIONID");$scope.tipMsg={},$scope.entranceFrom=0,$scope.cardNoDisabled=!1,$scope.setFocus=function(eId){var setTimer=posService.setFocus(eId);$scope.$on("$destroy",function(){$timeout.cancel(setTimer)})},$scope.editPasswdVo={cardNo:"",tsCode:"",oldPasswd:"",newPasswd:"",rePasswd:"",isValidNewPasswd:!1,sessionId:sessionId,forbideSave:!1},$scope.resetPasswdVo={cardNo:"",tsCode:"",sessionId:sessionId,forbideSave:!1},$rootScope.currentuserinfo&&($scope.entranceFrom=1,$scope.currUserInfo=$rootScope.currentuserinfo,$scope.editPasswdVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.resetPasswdVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.cardNoDisabled=!0),$scope.getMemeberAndCardInfo=function(cardNo){$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null;if(!cardNo||cardNo==""||!/^(((13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8})|([1-9](\d{4,9}|\d{11,15})))$/.test(cardNo))return!1;ajaxService.AjaxPost({paramValue:cardNo,sessionId:sessionId},"postrade/memberhome/memberhomeinfo.do").then(function(result){if(result.status&&result.data){var data=result.data;$rootScope.cardoperatetoeditusrmemberinfo=data.memberInfoBean,$rootScope.currentuserinfo=data,$scope.currUserInfo=$rootScope.currentuserinfo,$scope.editPasswdVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.resetPasswdVo.cardNo=$scope.currUserInfo.cardInfoBean.number}})},$scope.validatePasswd=function(){$scope.editPasswdVo.isValidNewPasswd=!1;var result=!1;return/^\d{6}$/.test($scope.editPasswdVo.rePasswd)?$scope.editPasswdVo.rePasswd!=$scope.editPasswdVo.newPasswd?($scope.tipMsg.repassword="新密码与确认密码不一致！",result=!0):$scope.editPasswdVo.isValidNewPasswd=!0:($scope.tipMsg.repassword="请输入6位确认密码！",result=!0),result},$scope.saveEditPasswd=function(){$scope.editPasswdVo.forbideSave=!0;if(!$scope.editPasswdVo.cardNo||$scope.editPasswdVo.cardNo==""||!/^[1-9](?:\d{0,9}|\d{11,15})$/.test($scope.editPasswdVo.cardNo))return modalService.info({title:"提示",content:"获取不到正确卡号!",size:"sm",type:"confirm"}),$scope.editPasswdVo.forbideSave=!1,!1;if(!$scope.editPasswdVo.oldPasswd||$scope.editPasswdVo.oldPasswd==""||!/^\d{6}$/.test($scope.editPasswdVo.oldPasswd))return modalService.info({title:"提示",content:"请输入6位旧密码!",size:"sm",type:"confirm"}),$scope.editPasswdVo.forbideSave=!1,!1;if(!$scope.editPasswdVo.newPasswd||$scope.editPasswdVo.newPasswd==""||!/^\d{6}$/.test($scope.editPasswdVo.newPasswd))return modalService.info({title:"提示",content:"请输入6位新密码!",size:"sm",type:"confirm"}),$scope.editPasswdVo.forbideSave=!1,!1;if(!$scope.editPasswdVo.rePasswd||$scope.editPasswdVo.rePasswd==""||$scope.editPasswdVo.rePasswd!=$scope.editPasswdVo.newPasswd)return modalService.info({title:"提示",content:"新密码与确认密码不一致!",size:"sm",type:"confirm"}),$scope.editPasswdVo.forbideSave=!1,!1;$scope.editPasswdVo.tsCode?trueSave():ajaxService.AjaxPost({sessionId:sessionId},"postrade/postscode/generatorTsCode.do").then(function(result){$scope.editPasswdVo.tsCode=result.tsCode,trueSave()},function(){$scope.editPasswdVo.forbideSave=!1})},$scope.goBack=function(){$scope.entranceFrom==0&&($rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null),posService.goBack()},$scope.saveResetPasswd=function(){$scope.resetPasswdVo.forbideSave=!0;if(!$scope.resetPasswdVo.cardNo||$scope.resetPasswdVo.cardNo==""||!/^[1-9](?:\d{0,9}|\d{11,15})$/.test($scope.resetPasswdVo.cardNo))return modalService.info({title:"提示",content:"获取不到正确卡号!",size:"sm",type:"confirm"}),$scope.resetPasswdVo.forbideSave=!1,!1;$scope.resetPasswdVo.tsCode?trueSave2():ajaxService.AjaxPost({sessionId:sessionId},"postrade/postscode/generatorTsCode.do").then(function(result){$scope.resetPasswdVo.tsCode=result.tsCode,trueSave2()},function(){$scope.resetPasswdVo.forbideSave=!1})}}]});