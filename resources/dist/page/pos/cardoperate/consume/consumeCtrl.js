define(["require","angular","posService","pos/cardoperate/poppasswd/poppasswdCtrl","text!pos/cardoperate/poppasswd/poppasswd.html"],function(require){var angular=require("angular"),posService=require("posService"),poppasswdCtrl=require("pos/cardoperate/poppasswd/poppasswdCtrl"),poppasswdTemp=require("text!pos/cardoperate/poppasswd/poppasswd.html");return["$scope","$window","ajaxService","posService","getCookieService","$rootScope","modalService","$uibModal",function($scope,$window,ajaxService,posService,getCookieService,$rootScope,modalService,$uibModal){function trueSave(){ajaxService.AjaxPost($scope.consumeVo,"postrade/consume/doConsume.do").then(function(result){result.status&&(modalService.info({content:"消费成功!",type:"ok"}),$scope.flg.isContinue?($scope.consumeVo={tsCode:0,cardNo:"",consumeMoney:0,consumeScore:0,scoreMoney:0,sessionId:sessionId},$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null):($scope.getMemeberAndCardInfo(),$scope.goBack())),$scope.flg.isSave=!0})}var sessionId=getCookieService.getCookie("CRMSESSIONID");$scope.consumeVo={sessionId:sessionId,tsCode:0,cardNo:"",allMoney:null,cardAllMoney:0,consumeMoney:0,consumeScore:0,scoreMoney:0,ableMoney:0,ableScore:0,posCardType:{},posScoreRule:{}},$scope.flg={isCardNo:!0,isScore:!1,isScoreFirst:!1,isContinue:!0,isSave:!0},$scope.getMemeberAndCardInfo=function(){$rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null,!!$scope.consumeVo.cardNo&&$scope.consumeVo.cardNo!=""&&!!/^(((13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8})|([1-9](\d{4,9}|\d{11,15})))$/.test($scope.consumeVo.cardNo)&&ajaxService.AjaxPost({paramValue:$scope.consumeVo.cardNo,sessionId:sessionId},"postrade/memberhome/memberhomeinfo.do").then(function(result){if(result.data!==null){var data=result.data;$rootScope.cardoperatetoeditusrmemberinfo=data.memberInfoBean,$rootScope.currentuserinfo=data,$scope.currUserInfo=angular.copy($rootScope.currentuserinfo),$scope.consumeVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.consumeVo.ableScore=$scope.currUserInfo.cardInfoBean.cardScore,$scope.consumeVo.ableMoney=$scope.currUserInfo.cardInfoBean.cardBalance,$scope.consumeVo.cardNo!=""&&$scope.getConsumeInfo()}else $rootScope.cardoperatetoeditusrmemberinfo=null,$rootScope.currentuserinfo=null})},$scope.getConsumeInfo=function(){ajaxService.AjaxPost({cardNo:$scope.consumeVo.cardNo,sessionId:sessionId},"postrade/consume/getConsume.do").then(function(result){$scope.consumeVo.posCardType=result.posCardType,$scope.consumeVo.posScoreRule=result.posScoreRule,$scope.consumeVo.posCardType.isScore==1&&$scope.consumeVo.posCardType.bmCardTypeScoreSet.isSocreMoney==1?($scope.flg.isScore=!0,$scope.consumeVo.posCardType.bmCardTypeScoreSet.isScoreMoneyFirst==1&&($scope.flg.isScoreFirst=!0)):($scope.flg.isScore=!1,$scope.flg.isScoreFirst=!1),Number($scope.consumeVo.allMoney)>0&&$scope.allMoneyChange()})},$rootScope.currentuserinfo&&($scope.flg.isContinue=!1,$scope.flg.isCardNo=!1,$scope.currUserInfo=angular.copy($rootScope.currentuserinfo),$scope.consumeVo.cardNo=$scope.currUserInfo.cardInfoBean.number,$scope.consumeVo.ableScore=$scope.currUserInfo.cardInfoBean.cardScore,$scope.consumeVo.ableMoney=$scope.currUserInfo.cardInfoBean.cardBalance,$scope.consumeVo.cardNo!=""&&$scope.getConsumeInfo()),$scope.doConsume=function(){$scope.consumeVo.cardAllMoney=Number($scope.consumeVo.allMoney);if($scope.consumeVo.cardAllMoney<=0)return modalService.info({content:"账单金额不能为零!",type:"ok"}),!1;if($scope.consumeVo.consumeScore>$scope.consumeVo.ableScore)return $scope.consumeVo.consumeScore=$scope.consumeVo.ableScore,modalService.info({content:"付款积分超出卡积分余额!",type:"ok"}),!1;if($scope.consumeVo.consumeMoney>$scope.consumeVo.ableMoney)return modalService.info({content:"付款金额超出卡余额!",type:"ok"}),!1;$scope.consumeVo.cardAllMoney=Number($scope.consumeVo.consumeMoney)+Number($scope.consumeVo.scoreMoney);if($scope.consumeVo.cardAllMoney!=$scope.consumeVo.allMoney)return console.log($scope.consumeVo.cardAllMoney),console.log($scope.consumeVo.allMoney),modalService.info({content:"实付总金额与账单金额不匹配!",type:"ok"}),!1;if(!$scope.flg.isSave)return!1;$scope.flg.isSave=!1,poppasswdModal()},$scope.allMoneyChange=function(){if($scope.consumeVo.allMoney==undefined){$scope.consumeVo.scoreMoney=0,$scope.consumeVo.consumeScore=0,$scope.consumeVo.consumeMoney=0;return}console.log(typeof $scope.consumeVo.allMoney),console.log($scope.consumeVo.allMoney);while($scope.consumeVo.allMoney!=""&&!$scope.consumeVo.allMoney.match(/^([1-9]\d{0,9}|0)(\.\d{0,2})?$/))console.log("ppp:"+$scope.consumeVo.allMoney),$scope.consumeVo.allMoney=$scope.consumeVo.allMoney.substring(0,$scope.consumeVo.allMoney.length-1);$scope.consumeVo.consumeScore=0,$scope.consumeVo.scoreMoney=0;var tepScoreMoney=$scope.consumeVo.scoreMoney;if($scope.flg.isScoreFirst){var scale=$scope.consumeVo.posCardType.bmCardTypeScoreSet.scoreMoneyScale,tempScore=$scope.consumeVo.allMoney*scale;tempScore=Math.floor(tempScore),tempScore=Math.min(tempScore,$scope.consumeVo.ableScore),$scope.consumeVo.consumeScore=tempScore,tepScoreMoney=(tempScore/scale).toFixed(2)}$scope.consumeVo.scoreMoney=tepScoreMoney,$scope.consumeVo.consumeMoney=Number($scope.consumeVo.allMoney)-tepScoreMoney,$scope.consumeVo.consumeMoney=$scope.consumeVo.consumeMoney.toFixed(2),$scope.consumeVo.consumeMoney>$scope.consumeVo.ableMoney&&($scope.consumeVo.consumeMoney=$scope.consumeVo.ableMoney)},$scope.scoreChange=function(){$scope.consumeVo.consumeScore=Number($scope.consumeVo.consumeScore),isNaN($scope.consumeVo.consumeScore)&&($scope.consumeVo.consumeScore=0),$scope.consumeVo.consumeScore>$scope.consumeVo.ableScore&&($scope.consumeVo.consumeScore=$scope.consumeVo.ableScore);var scale=$scope.consumeVo.posCardType.bmCardTypeScoreSet.scoreMoneyScale,tSm=($scope.consumeVo.consumeScore/scale).toFixed(2);$scope.consumeVo.scoreMoney=tSm;var tAm=Number($scope.consumeVo.allMoney);tAm=isNaN(tAm)?0:tAm,$scope.consumeVo.consumeMoney=tAm-tSm,$scope.consumeVo.consumeMoney=$scope.consumeVo.consumeMoney.toFixed(2),$scope.consumeVo.consumeMoney>$scope.consumeVo.ableMoney&&($scope.consumeVo.consumeMoney=$scope.consumeVo.ableMoney),$scope.consumeVo.consumeMoney<0&&($scope.consumeVo.consumeMoney=0)},$scope.caldiff=function(){var diffMoney=0,tAm=Number($scope.consumeVo.allMoney);return tAm=isNaN(tAm)?0:tAm,diffMoney=tAm-$scope.consumeVo.scoreMoney-$scope.consumeVo.consumeMoney,diffMoney.toFixed(2)};var poppasswdModal=function(){var modalInstance=$uibModal.open({animation:!0,template:poppasswdTemp,size:"sm",controller:"poppasswdCtrl",resolve:{}});modalInstance.result.then(function(popPasswd){$scope.consumeVo.pwd=popPasswd.password,$scope.consumeVo.tscode?trueSave():ajaxService.AjaxPost({sessionId:sessionId},"postrade/postscode/generatorTsCode.do").then(function(result){$scope.consumeVo.tsCode=result.tsCode,trueSave()})},function(data){$scope.flg.isSave=!0})};$scope.goBack=function(){posService.goBack()}}]});