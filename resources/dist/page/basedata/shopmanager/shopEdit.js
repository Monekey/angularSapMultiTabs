define(["require","ngAMD","angular","uploadService"],function(require){var ngAMD=require("ngAMD"),angular=require("angular"),upload=require("uploadService");ngAMD.controller("shopUpdateCtrl",["$scope","appConstant","ajaxService","register","uploadService","$rootScope","$uibModal","modalService",function($scope,appConstant,ajaxService,register,uploadService,$rootScope,$uibModal,modalService){var tabData=$rootScope.TabsData,data=angular.copy(tabData);$scope.shop=data,$scope.from=data.from,ajaxService.AjaxPost({sessionId:$rootScope.sessionId},"baseData/brandManager/combo.do").then(function(result){$scope.brandList=result.data}),$scope.division=appConstant.division;var provinceId=(data.cityId+"").substr(0,2);$scope.division.forEach(function(province){province.id==provinceId&&($scope.province=province,$scope.area=province.areas)});var cityId=(data.cityId+"").substr(0,4);require(["../../../lib/city/"+provinceId],function(city){$scope.province.subAreas=city.subAreas,city.subAreas.forEach(function(cityed){cityed.id==cityId&&($scope.city=cityed,cityed.subAreas.forEach(function(district){district.id==data.cityId&&($scope.district=district,$scope.$apply())}))})}),$scope.createBrand=function(){var modalInstance=$uibModal.open({animation:!0,template:"<div><div class='modal-header'>	<span class='modal-title'>新建品牌</span><i class='iconfont shops-edit-creat-i' ng-click='cancel()' style='cursor:pointer'>&#xe633;</i> </div><div class='modal-body'><form class='form-horizontal' autocomplete='off' name='insertBrandForm' ng-submit='addBrand(brandOne)' novalidate><div class='form-group'><div class='col-sm-8' style='padding-left:30px;padding-right:0px;'><input ng-model='brandOne' class='form-control' id='brandName' name='brandName' required ng-pattern='/^[A-Za-z0-9一-龥]{1,20}$/' placeholder='请输入品牌名'  tooltip-trigger='blur' uib-tooltip='{{insertBrandForm.brandName.$invalid?\"品牌名由数字、中文、英文组成\":\"\"}}' tooltip-placement='bottom'/></div><div class='col-sm-3'><button type='submit' class='btn btn-primary main-all-btn-b' ng-disabled='insertBrandForm.$invalid' >添加</button></div></div></form><div class='shop-edit-creat'><table class='table table-striped table-style-all'><tr ng-repeat='brand in brandList'><td><input ng-model='brand.showName' class='form-control' ng-blur='saveEditBrand(brand)' ng-disabled='!brand.isAbled'/></td><td><i class='iconfont' ng-click='editBrand(brand)' style='cursor:pointer'>&#xe63f;</i><i class='iconfont' ng-click='deleteBrand(brand)' style='cursor:pointer'>&#xe633;</i></td></tr></table></div></div></div>",size:"sm",resolve:{brandList:function(){return $scope.brandList}},controller:["$scope","$uibModalInstance","brandList",function($scope,$uibModalInstance,brandList){$scope.brandList=brandList,ajaxService.AjaxPost({sessionId:$rootScope.sessionId},"baseData/brandManager/combo.do").then(function(result){brandList=result.data}),$scope.brandOne="",$scope.priviousBrand={},$scope.addBrand=function(brandOne){ajaxService.AjaxPost({sessionId:$rootScope.sessionId,bmBrand:{name:brandOne}},"baseData/brandManager/create.do").then(function(result){result.status==1&&($scope.brandList.unshift({showName:result.bmBrand.name,value:result.bmBrand.id}),$scope.brandOne="")})},$scope.deleteBrand=function(brand){ajaxService.AjaxPost({sessionId:$rootScope.sessionId,id:brand.value},"baseData/brandManager/delete.do").then(function(result){if(result.status==1){var brandList=$scope.brandList;for(var i=0;i<brandList.length;i++)if(brandList[i].value==brand.value){brandList.splice(i,1);break}}})},$scope.editBrand=function(brand){if($scope.priviousBrand&&$scope.priviousBrand.value==brand.value&&brand.isAbled)return brand.isAbled=!1,!1;$scope.priviousBrand=angular.copy(brand);if($scope.brandList&&$scope.brandList.length>0)for(var i=0;i<$scope.brandList.length;i++){var brandTemp=$scope.brandList[i];brandTemp.value==brand.value?brandTemp.isAbled=!0:brandTemp.isAbled=!1}},$scope.saveEditBrand=function(brand){if($scope.priviousBrand.showName==brand.showName)return brand.isAbled=!1,$scope.priviousBrand={},!1;if(!/^[A-Za-z0-9\u4e00-\u9fa5]{1,20}$/.test(brand.showName))return modalService.info({title:"提示",content:"品牌名由数字、中文、英文组成",size:"sm",type:"confirm"}),brand.showName=$scope.priviousBrand.showName,!1;ajaxService.AjaxPost({sessionId:$rootScope.sessionId,bmBrand:{id:brand.value,name:brand.showName}},"baseData/brandManager/update.do").then(function(result){result.status?(brand.isAbled=!1,$scope.priviousBrand={}):brand.showName=$scope.priviousBrand.showName},function(data){brand.showName=$scope.priviousBrand.showName})},$scope.cancel=function(){$scope.priviousBrand={};if($scope.brandList&&$scope.brandList.length>0)for(var i=0;i<$scope.brandList.length;i++){var brandTemp=$scope.brandList[i];if(brandTemp.showName=="")return!1}$uibModalInstance.dismiss("cancel")}}]});modalInstance.result.then(function(obj){console.log(obj)})},$scope.changeProvince=function(province){$scope.city="",$scope.district="",$scope.division.forEach(function(item){if(province.id==item.id){areas=item.areas,$scope.area=areas;return}}),province.id&&require(["../../../lib/city/"+province.id],function(city){province.subAreas=city.subAreas,$scope.$apply()})},$scope.getValid=function(name){if(name)return name.match(/^1[3|4|5|7|8]\d{9}$/)?!1:!0},$scope.saveShop=function(shop){var data={id:shop.id,name:shop.name,brandId:shop.brandId,address:shop.address,linkMan:shop.linkMan,phone:shop.phone,cityId:parseInt($scope.district.id)},param={shopBean:data,sessionId:$rootScope.sessionId};$scope.shop.img||$scope.shop.img==null?(param.shopBean.img=$scope.shop.img,ajaxService.AjaxPost(param,"baseData/shopManager/update.do").then(function(result){modalService.info({content:"修改成功!",type:"ok"}).then(function(obj){obj.status=="ok"&&($scope.shop.callback(),register.switchTab({id:$scope.from}))},function(){$scope.shop.callback(),register.switchTab({id:$scope.from})})})):uploadService.uploadFile($scope.file,"baseData/shopManager/updateHasFile.do",param).then(function(result){modalService.info({content:"修改成功!",type:"ok"}).then(function(obj){obj.status=="ok"&&($scope.shop.callback(),register.switchTab({id:$scope.from}))},function(){$scope.shop.callback(),register.switchTab({id:$scope.from})})})},$scope.uploadShopImg=function(file,picId,fileId){if(file==null)return;$scope.shop.img="",$scope.file=file},$scope.cancel=function(){register.switchTab({id:$scope.from})}}])});