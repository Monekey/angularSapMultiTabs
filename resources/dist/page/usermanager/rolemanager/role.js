define(["require","css!role_css","angular","css!zTree_css","jquery","zTree","ngAMD"],function(require){var role_css=require("css!role_css"),angular=require("angular"),zTree_css=require("css!zTree_css"),$=require("jquery"),zTree=require("zTree"),ngAMD=require("ngAMD");return ngAMD.controller("roleManager",["$scope","$rootScope","appConstant","ajaxService","modalService","$timeout","register",function($scope,$rootScope,appConstant,ajaxService,modalService,$timeout,register){function loadAuthority(roleId){$scope.roleId=roleId;var testParam={sessionId:sessionId,roleId:roleId};ajaxService.AjaxPost(testParam,"usermanager/rolemanager/GetFunctionTree.do").then(function(result){if(result){$scope.menus=result.data,$scope.clickChildSystem=$scope.menus[0];for(var i=0;i<$scope.menus.length;i++)$scope.menus[i].authority===1?$scope.menus[i].authority=!0:$scope.menus[i].authority=!1,$scope.menus[i].$tag=$scope.menus[i].authority,$scope.menus[i].code==="10001"&&($scope.backManage=$scope.menus[i],$scope.clickChildSystem&&$scope.clickChildSystem.showName===$scope.backManage.showName&&($scope.clickChildSystem=$scope.backManage),$scope.backMenuTree=getMenuTrees($scope.backManage.childTree),$scope.backOperationTree=getOperationTrees($scope.backManage.childTree),$scope.backSonCount=getAllLastNode($scope.backMenuTree).length,$scope.backSelectSonCount=getAllSelectNode(getAllLastNode($scope.backMenuTree)).length,$scope.checkAllBack=$scope.backSonCount===$scope.backSelectSonCount?!0:!1),$scope.menus[i].code==="10002"&&($scope.reportManage=$scope.menus[i],$scope.clickChildSystem&&$scope.clickChildSystem.showName===$scope.reportManage.showName&&($scope.clickChildSystem=$scope.reportManage),$scope.reportMenuTree=getMenuTrees($scope.reportManage.childTree),$scope.reportOperationTree=getOperationTrees($scope.reportManage.childTree),$scope.reportSonCount=getAllLastNode($scope.reportMenuTree).length,$scope.reportSelectSonCount=getAllSelectNode(getAllLastNode($scope.reportMenuTree)).length,$scope.checkAllReport=$scope.reportSonCount===$scope.reportSelectSonCount?!0:!1),$scope.menus[i].code==="10003"&&($scope.frontManage=$scope.menus[i],$scope.clickChildSystem&&$scope.clickChildSystem.showName===$scope.frontManage.showName&&($scope.clickChildSystem=$scope.frontManage),$scope.frontMenuTree=getMenuTrees($scope.frontManage.childTree),$scope.frontOperationTree=getOperationTrees($scope.frontManage.childTree),$scope.frontSonCount=getAllLastNode($scope.frontMenuTree).length,$scope.frontSelectSonCount=getAllSelectNode(getAllLastNode($scope.frontMenuTree)).length,$scope.checkAllFront=$scope.frontSonCount===$scope.frontSelectSonCount?!0:!1);$.fn.zTree.init($("#backTree"),$scope.backSetting,$scope.backMenuTree),$.fn.zTree.init($("#reportTree"),$scope.reportSetting,$scope.reportMenuTree),$.fn.zTree.init($("#frontTree"),$scope.frontSetting,$scope.frontMenuTree)}})}function getMenuTrees(trees){var menuTrees=[];for(var i=0;i<trees.length;i++)trees[i].type!==3&&(trees[i].authority===1?trees[i].authority=!0:trees[i].authority=!1,trees[i].$tag=trees[i].authority,menuTrees.push(trees[i]));return menuTrees}function getOperationTrees(trees){var operationTrees=[];for(var i=0;i<trees.length;i++)trees[i].type===3&&(trees[i].authority===1?trees[i].authority=!0:trees[i].authority=!1,trees[i].$tag=trees[i].authority,operationTrees.push(trees[i]));return operationTrees}function getAllLastNode(trees){var allSonNode=[];for(var i=0;i<trees.length;i++)trees[i].type!==3&&findSonNode(trees[i],trees)===!1&&allSonNode.push(trees[i]);return allSonNode}function findSonNode(node,trees){for(var i=0;i<trees.length;i++)if(node.code===trees[i].fatherCode)return!0;return!1}function getAllSelectNode(trees){var allSelectNode=[];for(var i=0;i<trees.length;i++)trees[i].authority===!0&&allSelectNode.push(trees[i]);return allSelectNode}function removeChildren(arr){for(var i=0;i<arr.length;i++)arr[i].children&&delete arr[i].children;return arr}function getChangeAuthority(arr,arr2){for(var i=0;i<arr.length;i++)if(arr[i].authority!==arr[i].$tag){var author={};author.roleId=$scope.roleId,author.functionId=arr[i].code,author.functionFlg=arr[i].authority===!0?1:0,arr2.push(author)}}$scope.createOrEdit=-1,$scope.createRole=register.getRoot("新建"),$scope.editRole=register.getRoot("修改"),$scope.deleteRole=register.getRoot("删除"),$scope.updateRole=register.getRoot("修改权限");var sessionId=$rootScope.sessionId,testParam1={sessionId:sessionId};$scope.type=3,$scope.status={open:!1},$scope.roleEdit={},ajaxService.AjaxPost(testParam1,"usermanager/rolemanager/list.do").then(function(result){result&&($scope.roles=result.data,$scope.roles.length>0&&($scope.clickedRole=$scope.roles[0],loadAuthority($scope.roles[0].id)))}),$scope.setRole=function(role){$scope.clickedRole=role,loadAuthority(role.id)},$scope.openCreate=function(){$scope.status.open=!0,$scope.createOrEdit=1},$scope.openEdit=function(){$scope.status.open=!0,$scope.createOrEdit=2,$scope.roleEdit=angular.copy($scope.clickedRole)},$scope.colseEdit=function(){$scope.status.open=!1,$scope.roleEdit={}},$scope.setting={data:{key:{name:"showName",title:"showName",checked:"authority"},simpleData:{enable:!0,idKey:"code",pIdKey:"fatherCode",rootPId:null}},check:{enable:!0,autoCheckTrigger:!0},callback:{},view:{showIcon:!1}},$scope.backSetting=angular.copy($scope.setting),$scope.backSetting.callback.onClick=function setFilterCode(event,treeId,treeNode){$timeout(function(){treeNode&&($scope.backFilterCode=treeNode.code,$scope.operationParentNode=treeNode)})},$scope.backSetting.callback.onCheck=function changeSonChild(event,treeId,treeNode){$timeout(function(){if(treeNode){for(var i=0;i<$scope.backOperationTree.length;i++)$scope.backOperationTree[i].fatherCode===treeNode.code&&($scope.backOperationTree[i].authority=treeNode.authority);var backTreeObj=$.fn.zTree.getZTreeObj("backTree");$scope.backMenuTree=removeChildren(backTreeObj.transformToArray(backTreeObj.getNodes())),backTreeObj.destroy(),$.fn.zTree.init($("#backTree"),$scope.backSetting,$scope.backMenuTree),$scope.backSelectSonCount=getAllSelectNode(getAllLastNode($scope.backMenuTree)).length,$scope.checkAllBack=$scope.backSonCount===$scope.backSelectSonCount?!0:!1}})},$scope.checkFatherNode=function(operation){operation.authority===!0?operation.authority=!1:operation.authority=!0;var treeNode=$scope.operationParentNode,flag=!0,unchecked=0,allOp=0;for(var i=0;i<$scope.backOperationTree.length;i++)$scope.backOperationTree[i].fatherCode===treeNode.code&&($scope.backOperationTree[i].authority||(flag=!1,unchecked++),allOp++);var backTreeObj=$.fn.zTree.getZTreeObj("backTree");unchecked>0&&unchecked!=allOp?backTreeObj.checkNode(treeNode,!0):unchecked==allOp?backTreeObj.checkNode(treeNode,!1):backTreeObj.checkNode(treeNode,!0)},$scope.reportSetting=angular.copy($scope.setting),$scope.reportSetting.callback.onClick=function setFilterCode(event,treeId,treeNode){$timeout(function(){treeNode&&($scope.reportFilterCode=treeNode.code,$scope.operationReportParentNode=treeNode)})},$scope.reportSetting.callback.onCheck=function changeSonChild(event,treeId,treeNode){$timeout(function(){if(treeNode){for(var i=0;i<$scope.reportOperationTree.length;i++)$scope.reportOperationTree[i].fatherCode===treeNode.code&&($scope.reportOperationTree[i].authority=treeNode.authority);var reportTreeObj=$.fn.zTree.getZTreeObj("reportTree");$scope.reportMenuTree=removeChildren(reportTreeObj.transformToArray(reportTreeObj.getNodes())),reportTreeObj.destroy(),$.fn.zTree.init($("#reportTree"),$scope.reportSetting,$scope.reportMenuTree),$scope.reportSelectSonCount=getAllSelectNode(getAllLastNode($scope.reportMenuTree)).length,$scope.checkAllReport=$scope.reportSonCount===$scope.reportSelectSonCount?!0:!1}})},$scope.checkReportFatherNode=function(operation){operation.authority===!0?operation.authority=!1:operation.authority=!0;var treeNode=$scope.operationReportParentNode,flag=!0,unchecked=0,allOp=0;for(var i=0;i<$scope.reportOperationTree.length;i++)$scope.reportOperationTree[i].fatherCode===treeNode.code&&($scope.reportOperationTree[i].authority||(flag=!1,unchecked++),allOp++);var backTreeObj=$.fn.zTree.getZTreeObj("reportTree");unchecked>0&&unchecked!=allOp?backTreeObj.checkNode(treeNode,!0):unchecked==allOp?backTreeObj.checkNode(treeNode,!1):backTreeObj.checkNode(treeNode,!0)},$scope.frontSetting=angular.copy($scope.setting),$scope.frontSetting.callback.onClick=function setFilterCode(event,treeId,treeNode){$timeout(function(){treeNode&&($scope.frontFilterCode=treeNode.code,$scope.operationFrontParentNode=treeNode)})},$scope.frontSetting.callback.onCheck=function changeSonChild(event,treeId,treeNode){$timeout(function(){if(treeNode){for(var i=0;i<$scope.frontOperationTree.length;i++)$scope.frontOperationTree[i].fatherCode===treeNode.code&&($scope.frontOperationTree[i].authority=treeNode.authority);var frontTreeObj=$.fn.zTree.getZTreeObj("frontTree");$scope.frontMenuTree=removeChildren(frontTreeObj.transformToArray(frontTreeObj.getNodes())),frontTreeObj.destroy(),$.fn.zTree.init($("#frontTree"),$scope.frontSetting,$scope.frontMenuTree),$scope.frontSelectSonCount=getAllSelectNode(getAllLastNode($scope.frontMenuTree)).length,$scope.checkAllFront=$scope.frontSonCount===$scope.frontSelectSonCount?!0:!1}})},$scope.checkFrontFatherNode=function(operation){operation.authority===!0?operation.authority=!1:operation.authority=!0;var treeNode=$scope.operationFrontParentNode,flag=!0,unchecked=0,allOp=0;for(var i=0;i<$scope.frontOperationTree.length;i++)$scope.frontOperationTree[i].fatherCode===treeNode.code&&($scope.frontOperationTree[i].authority||(flag=!1,unchecked++),allOp++);var backTreeObj=$.fn.zTree.getZTreeObj("reportTree");unchecked>0&&unchecked!=allOp?backTreeObj.checkNode(treeNode,!0):unchecked==allOp?backTreeObj.checkNode(treeNode,!1):backTreeObj.checkNode(treeNode,!0)},$scope.openMenus=function(childSystem){$scope.clickChildSystem=childSystem},$scope.checkAllBackManage=function(){$scope.checkAllBack===!0?$scope.checkAllBack=!1:$scope.checkAllBack=!0;var backTreeObj=$.fn.zTree.getZTreeObj("backTree");backTreeObj.checkAllNodes($scope.checkAllBack),$scope.backMenuTree=removeChildren(backTreeObj.transformToArray(backTreeObj.getNodes())),backTreeObj.destroy(),$.fn.zTree.init($("#backTree"),$scope.backSetting,$scope.backMenuTree),$scope.backSelectSonCount=getAllSelectNode(getAllLastNode($scope.backMenuTree)).length},$scope.checkAllReportManage=function(){$scope.checkAllReport===!0?$scope.checkAllReport=!1:$scope.checkAllReport=!0;var reportTreeObj=$.fn.zTree.getZTreeObj("reportTree");reportTreeObj.checkAllNodes($scope.checkAllReport),$scope.reportMenuTree=removeChildren(reportTreeObj.transformToArray(reportTreeObj.getNodes())),reportTreeObj.destroy(),$.fn.zTree.init($("#reportTree"),$scope.reportSetting,$scope.reportMenuTree),$scope.reportSelectSonCount=getAllSelectNode(getAllLastNode($scope.reportMenuTree)).length},$scope.checkAllFrontManage=function(){$scope.checkAllFront===!0?$scope.checkAllFront=!1:$scope.checkAllFront=!0;var frontTreeObj=$.fn.zTree.getZTreeObj("frontTree");frontTreeObj.checkAllNodes($scope.checkAllFront),$scope.frontMenuTree=removeChildren(frontTreeObj.transformToArray(frontTreeObj.getNodes())),frontTreeObj.destroy(),$.fn.zTree.init($("#frontTree"),$scope.frontSetting,$scope.frontMenuTree),$scope.frontSelectSonCount=getAllSelectNode(getAllLastNode($scope.frontMenuTree)).length},$scope.saveAuthority=function(){var authorityList=[];$scope.backSelectSonCount===0?$scope.backManage.authority=!1:$scope.backManage.authority=!0;if($scope.backManage.authority!==$scope.backManage.$tag){var author={};author.roleId=$scope.roleId,author.functionId=$scope.backManage.code,author.functionFlg=$scope.backManage.authority===!0?1:0,authorityList.push(author)}$scope.reportSelectSonCount===0?$scope.reportManage.authority=!1:$scope.reportManage.authority=!0;if($scope.reportManage.authority!==$scope.reportManage.$tag){var author={};author.roleId=$scope.roleId,author.functionId=$scope.reportManage.code,author.functionFlg=$scope.reportManage.authority===!0?1:0,authorityList.push(author)}$scope.frontSelectSonCount===0?$scope.frontManage.authority=!1:$scope.frontManage.authority=!0;if($scope.frontManage.authority!==$scope.frontManage.$tag){var author={};author.roleId=$scope.roleId,author.functionId=$scope.frontManage.code,author.functionFlg=$scope.frontManage.authority===!0?1:0,authorityList.push(author)}getChangeAuthority($scope.backMenuTree,authorityList),getChangeAuthority($scope.reportMenuTree,authorityList),getChangeAuthority($scope.frontMenuTree,authorityList),getChangeAuthority($scope.backOperationTree,authorityList),getChangeAuthority($scope.reportOperationTree,authorityList),getChangeAuthority($scope.frontOperationTree,authorityList),window.console.log(authorityList);var param={sessionId:sessionId,roleId:$scope.roleId,functions:authorityList};ajaxService.AjaxPost(param,"usermanager/rolemanager/edit.do").then(function(result){result&&result.status===1&&modalService.info({title:"提示",content:"保存成功！",size:"sm",type:"ok"})})},$scope.editRole=function(){var editParam={sessionId:sessionId,createOrEdit:$scope.createOrEdit,roleName:$scope.roleEdit.name,roleId:$scope.roleEdit.id};ajaxService.AjaxPost(editParam,"usermanager/rolemanager/edit.do").then(function(result){result&&result.status&&ajaxService.AjaxPost(testParam1,"usermanager/rolemanager/list.do").then(function(result){result&&($scope.roles=result.data,$scope.status.open=!1,$scope.createOrEdit=-1,$scope.setRole($scope.roleEdit),$scope.roleEdit={})})})},$scope.deleteRole=function(){modalService.info({title:"提示",content:"确定要删除角色"+$scope.clickedRole.name+"吗？",size:"sm",type:"todo"}).then(function(){var deleteParam={sessionId:sessionId,roleId:$scope.clickedRole.id};ajaxService.AjaxPost(deleteParam,"usermanager/rolemanager/delete.do").then(function(result){result&&(modalService.info({content:"删除成功！",type:"ok",delay:1e3}),ajaxService.AjaxPost(testParam1,"usermanager/rolemanager/list.do").then(function(result){result&&($scope.roles=result.data,$scope.status.open=!1)}))})})}}]),"roleManager"});