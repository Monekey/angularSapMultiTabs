define(["require","css!emp_css","ngAMD","angular","shopSelector","usermanager/empmanager/empImport","text!usermanager/empmanager/empImport.html"],function(require){var emp_css=require("css!emp_css"),submitFlg=!1,ngAMD=require("ngAMD"),angular=require("angular"),shopselector=require("shopSelector");ngAMD.controller("invationController",["$scope","$rootScope","ajaxService","$uibModal","$log","register","shopSelectorService","modalService",function($scope,$rootScope,ajaxService,$uibModal,$log,register,shopSelectorService,modalService){function convertModalShop(shops){var newShops=[];for(var i=0;i<shops.length;i++){var shop={};shop.shopId=shops[i].code,shop.shopName=shops[i].showName,shop.bindFlg=shops[i].bindFlg,newShops.push(shop)}return newShops}function convertModalShop1(shops){var newShops1=[];for(var i=0;i<shops.length;i++){var shop={};shop.code=shops[i].shopId,shop.showName=shops[i].shopName,shop.bindFlg=1,newShops1.push(shop)}return newShops1}$scope.employeeCreate={empInfos:[],roleId:"",sessionId:$rootScope.sessionId,shopIds:{}};var sessionId=$rootScope.sessionId,data=$rootScope.TabsData;$scope.changeItems=[],$scope.accountTypes=[{text:"手机号码",value:"phone"},{text:"电子邮箱",value:"email"}],$scope.from=data.from,$scope.tempObj={value:1};var param={sessionId:sessionId},empBusines={accountType:"phone",phone:"",email:"",empName:""};$scope.empBusiness=[empBusines],$scope.addRow=function(){$scope.empBusiness.push({accountType:"phone",phone:"",email:"",empName:""})},$scope.minusRow=function(index){$scope.empBusiness.splice(index,1)},$scope.OnInput=function(name){if(name)return name+="",name.match(/[^\a-\z\A-\Z0-9\u4E00-\u9FA5]/g)?!0:!1;if($scope.focu==1)return!0},$scope.InputPE=function(value,name){if(value==1&&!angular.isUndefined(name))return name.match(/^1[3|4|5|7|8]\d{9}$/)?(console.log(value),!0):!1;if(value==2&&!angular.isUndefined(name))return name.match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/)?!0:!1;if($scope.focu==1)return!0},$scope.getValid=function(name){if(name)return name+="",/.*[\u4e00-\u9fa5]+.*$/.test(name)?!0:name.match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/)||name.match(/^1[3|4|5|7|8]\d{9}$/)?!1:!0;if($scope.focu==1)return!0},$scope.validAll=function(){var f=!0;return angular.forEach($scope.empBusiness,function(item,index){if($scope.getValid(item.email))return f=!1,!0;if($scope.getValidNm(item.empName)==""?!1:!0)return f=!1,!0}),f?!1:!0},$scope.getValidNm=function(name){if(name){name+="";var cnum=0;for(var v=0;v<name.length;v++){var c=name.charAt(v),ccode=name.charCodeAt(v);if(!c.match(/^([a-zA-Z0-9\u4E00-\u9FA5])/))return"请正确填写姓名,不能含有特殊字符";ccode>255?cnum+=2:cnum+=1;if(cnum>16)return"请正确填写姓名,长度最大16字节"}return""}if($scope.focu==1)return""},ajaxService.AjaxPost(param,"usermanager/rolemanager/getRoleCombo.do").then(function(result){$scope.roleList=result.data}),$scope.cancelIn=function(){register.switchTab({id:$scope.from})},$scope.$watch("status.limit",function(limit){limit&&limit===!0&&ajaxService.AjaxPost({sessionId:sessionId},"memberequity/cardtype/limitSet.do").then(function(result){result&&($scope.limitSet=result.limitSet)})}),$scope.showModal=function(){var showFlg=1,initItems=[],currentItems=$scope.shopIds?convertModalShop1($scope.shopIds):[];console.log(currentItems);var paramSet={serviceType:"shop",shop:{brand:1,city:2,ajaxUrl:"baseData/shopManager/getShopTree.do"},initItems:initItems,currentItems:currentItems,showFlg:1};shopSelectorService.openShopModal(paramSet).then(function(result){$scope.shopIds=convertModalShop(result.allSelectedItems),console.log($scope.shopIds),$scope.changeItems=convertModalShop(result.changeItems)})},$scope.showImport=function(){var empImportCtrl=require("usermanager/empmanager/empImport"),empImportPage=require("text!usermanager/empmanager/empImport.html"),modalInstance=$uibModal.open({animation:!1,template:empImportPage,size:"sm",controller:"empImportCtrl",resolve:{noticeEmps:function(){return null}}});modalInstance.result.then(function(penm){for(var i=0;i<penm.length;i++){var row=penm[i];console.log(row[0]+" "+row[1]);var pe=row[0],nm=row[1],at=pe.indexOf("@")>0?"email":"phone",row=null;i==0&&($scope.empBusiness.length=0),$scope.empBusiness.push(row={accountType:"",phone:"",email:"",empName:""}),row.accountType=at,row.email=pe,row.empName=nm}})},$scope.getTemplate=function(){var a=document.createElement("a");document.body.appendChild(a),a.href="resources/page/usermanager/empmanager/empbatch.xlsx",a.target="_blank",a.click()},$scope.createNew=function(){register.openTabWithRequest({id:10025},{})};var empInfo={empInfos:[],sessionId:sessionId};$scope.submitForm=function(){var contactInfo=[],sessionId=$rootScope.sessionId,roleList=$scope.roleList;for(var a=0;a<roleList.length;a++)$scope.roleName==roleList[a].showName&&($scope.employeeCreate.roleId=roleList[a].value);$scope.changeItems&&$scope.changeItems.length>0&&($scope.employeeCreate.shopIds=$scope.changeItems),$scope.invationEmpVo=$scope.employeeCreate,console.log($scope.invationEmpVo),$scope.employeeCreate.empInfos=[],angular.forEach($scope.empBusiness,function(item,index,array){var curItem={email:null,phone:null,empName:item.empName};item.accountType=="phone"?curItem.phone=item.email:curItem.email=item.email,empInfo.empInfos.push(curItem),$scope.employeeCreate.empInfos.push(curItem)});var sub=function(){ajaxService.AjaxPost(empInfo,"userManager/empManager/checkExist.do").then(function(result){result.nameExistFlg==1?modalService.info({title:"提示",content:"姓名已存在，是否继续？",size:"sm",type:"dialog"}).then(function(result){ajaxService.AjaxPost($scope.invationEmpVo,"userManager/empManager/create.do").then(function(result){result.status==1&&modalService.info({title:"提示",content:result.msg,size:"sm",type:"confirm"}).then(function(result){register.switchTab({id:$scope.from})})})}):ajaxService.AjaxPost($scope.invationEmpVo,"userManager/empManager/create.do").then(function(result){result.status==1&&modalService.info({title:"提示",content:result.msg,size:"sm",type:"confirm"}).then(function(result){register.switchTab({id:$scope.from})})})})};for(var k=0;k<$scope.employeeCreate.empInfos.length;k++){var thiEmp=$scope.employeeCreate.empInfos[k];for(var p=0;p<$scope.employeeCreate.empInfos.length;p++){var othEmp=$scope.employeeCreate.empInfos[p];if(k!=p&&thiEmp.empName==othEmp.empName){modalService.info({title:"提示",content:"不能输入重复姓名，是否继续？",size:"sm",type:"dialog"}).then(function(){sub()});return}}}sub()}}])});