define(["require","css!score_rule_css","css!alert_manage_css","angular","systemmanager/alertmanage/recipientSelector","text!systemmanager/alertmanage/recipientSelector.html","ngAMD"],function(require){var score_rule_css=require("css!score_rule_css"),alert_manage_css=require("css!alert_manage_css"),angular=require("angular"),recipientCtrl=require("systemmanager/alertmanage/recipientSelector"),recipientTemp=require("text!systemmanager/alertmanage/recipientSelector.html"),ngAMD=require("ngAMD");return ngAMD.controller("alertManageCtrl",["$scope","$rootScope","ajaxService","appConstant","$uibModal","register","modalService",function($scope,$rootScope,ajaxService,appConstant,$uibModal,register,modalService){function refreshWarnings(){$scope.warnings=[],$scope.oderWarning={},$scope.smsWarning={},$scope.saleWarning={},$scope.consumeWarning={},$scope.errorCountWarning={},ajaxService.AjaxPost({sessionId:sessionId},"systemmanager/alertmanager/load.do").then(function(result){if(result){$scope.warnings=result.data;var warnings=$scope.warnings;for(var i=0;i<warnings.length;i++)warnings[i].ruleInfo=JSON.parse(warnings[i].ruleInfo),warnings[i].type==1?(warnings[i].operation==1&&($scope.consumeWarning=warnings[i]),warnings[i].operation==2&&($scope.saleWarning=warnings[i]),warnings[i].operation==3&&($scope.errorCountWarning=warnings[i]),$scope.lockFlg=$scope.consumeWarning.lockFlg?$scope.consumeWarning.lockFlg:0):warnings[i].type==2&&warnings[i].operation==4?$scope.oderWarning=warnings[i]:warnings[i].type==3&&warnings[i].operation==5&&($scope.smsWarning=warnings[i])}})}function updateWarning(testParam){ajaxService.AjaxPost(testParam,"systemmanager/alertmanager/edit.do").then(function(result){result&&result.status==1&&(modalService.info({content:"保存成功！",type:"ok"}),refreshWarnings())})}function createWarning(testParam){ajaxService.AjaxPost(testParam,"systemmanager/alertmanager/create.do").then(function(result){result&&result.status==1&&(modalService.info({content:"保存成功！",type:"ok"}),refreshWarnings())})}function inArray(arr,item){for(var i=0;i<arr.length;i++)if(arr[i].empId==item.empId)return i;return-1}function updateArr(arr,type){for(var i=0;i<arr.length;i++)arr[i].type=type}function refreshlogs(){ajaxService.AjaxPost($scope.conditions.request,"systemmanager/alertlog/list.do").then(function(result){result&&($scope.$$childTail.$$childHead.resultList=result,$scope.$$phase||$scope.$apply())})}$scope.edit=register.getRoot("编辑"),$scope.ignore=register.getRoot("忽略"),$scope.ignoreAll=register.getRoot("全部忽略"),$scope.ignoreByCard=register.getRoot("本卡忽略"),$scope.detail=register.getRoot("详情");var sessionId=$rootScope.sessionId;$scope.warning={};var initRecipients=[];ajaxService.AjaxPost({sessionId:sessionId},"systemmanager/alertmanager/getNoticeEmpList.do").then(function(result){result&&($scope.recipients=result.data,initRecipients=angular.copy($scope.recipients))}),refreshWarnings(),$scope.saveWarning=function(warning){$scope.warning=warning,$scope.warnings.push($scope.warning),$scope.showAdd=!1},$scope.saveAndAddWarning=function(warning){$scope.warning=warning,$scope.warnings.push($scope.warning),$scope.showAdd=!0},$scope.updateWarning=function(warning){$scope.warning=warning,$scope.cancelWarning()},$scope.cancelWarning=function(){$scope.showAdd=!1,$scope.isShow=!0},$scope.addWarning=function(){$scope.isShow=!1,$scope.showAdd=!0},$scope.saveTransactionWarning=function(consumeWarning,saleWarning,errorCountWarning){var updateArr=[],createArr=[];consumeWarning.lockFlg===1?(saleWarning.lockFlg=consumeWarning.lockFlg,errorCountWarning.lockFlg=consumeWarning.lockFlg):(consumeWarning.lockFlg=0,saleWarning.lockFlg=0,errorCountWarning.lockFlg=0),consumeWarning.ruleInfo=JSON.stringify(consumeWarning.ruleInfo),saleWarning.ruleInfo=JSON.stringify(saleWarning.ruleInfo),errorCountWarning.ruleInfo=JSON.stringify(errorCountWarning.ruleInfo);var testParam1={sessionId:sessionId},testParam2={sessionId:sessionId};consumeWarning.id?updateArr.push(consumeWarning):(consumeWarning.type=1,consumeWarning.operation=1,createArr.push(consumeWarning)),saleWarning.id?updateArr.push(saleWarning):(saleWarning.type=1,saleWarning.operation=2,createArr.push(saleWarning)),errorCountWarning.id?updateArr.push(errorCountWarning):(errorCountWarning.type=1,errorCountWarning.operation=3,createArr.push(errorCountWarning)),updateArr.length!==0&&(testParam1.alertCreateBean=updateArr,updateWarning(testParam1)),createArr.length!==0&&(testParam2.alertCreateBean=createArr,createWarning(testParam2))},$scope.saveOrderWarning=function(orderWarning){var alertCreateBean=[],testParam={sessionId:sessionId};orderWarning.ruleInfo=JSON.stringify(orderWarning.ruleInfo),orderWarning.id?(alertCreateBean.push(orderWarning),testParam.alertCreateBean=alertCreateBean,updateWarning(testParam)):(orderWarning.type=2,orderWarning.operation=4,alertCreateBean.push(orderWarning),testParam.alertCreateBean=alertCreateBean,createWarning(testParam))},$scope.saveMessageWarning=function(smsWarning){var alertCreateBean=[],testParam={sessionId:sessionId};smsWarning.ruleInfo=JSON.stringify(smsWarning.ruleInfo),smsWarning.id?(alertCreateBean.push(smsWarning),testParam.alertCreateBean=alertCreateBean,updateWarning(testParam)):(smsWarning.type=3,smsWarning.operation=5,alertCreateBean.push(smsWarning),testParam.alertCreateBean=alertCreateBean,createWarning(testParam))},$scope.showRecipientModal=function(){var modalInstance=$uibModal.open({animation:!0,template:recipientTemp,size:"lg",controller:"recipientSelectorCtrl",resolve:{noticeEmps:function(){return $scope.recipients}}});modalInstance.result.then(function(selectedItem){for(var i=0;i<selectedItem.length;i++){var recipient={};recipient.empId=selectedItem[i].empId,recipient.empName=selectedItem[i].empName,recipient.businessFlg=1,recipient.orderFlg=1,recipient.smsFlg=1,$scope.recipients.push(recipient)}})},$scope.minusNotice=function($index){$scope.recipients.splice($index,1)},$scope.saveNotice=function(){var testParam={sessionId:sessionId},alertNoticeRelationConfig=[],recipients=angular.copy($scope.recipients),excuteRecipients=angular.copy(recipients),initRecipientsArr=angular.copy(initRecipients),excuteInitRecipientsArr=angular.copy(initRecipientsArr);for(var i=0;i<recipients.length;i++){var isExist=!1;for(var j=0;j<initRecipientsArr.length;j++)if(recipients[i].empId===initRecipientsArr[j].empId){if(recipients[i].businessFlg!==initRecipientsArr[j].businessFlg||recipients[i].orderFlg!==initRecipientsArr[j].orderFlg||recipients[i].smsFlg!==initRecipientsArr[j].smsFlg){var recipient=recipients[i];recipient.type="UPDATE",alertNoticeRelationConfig.push(recipient)}if(inArray(excuteInitRecipientsArr,initRecipientsArr[j])!==-1){excuteInitRecipientsArr.splice(inArray(excuteInitRecipientsArr,initRecipientsArr[j]),1),isExist=!0;break}}isExist===!0&&inArray(excuteRecipients,recipients[i])!==-1&&excuteRecipients.splice(inArray(excuteRecipients,recipients[i]),1)}updateArr(excuteRecipients,"ADD"),alertNoticeRelationConfig=alertNoticeRelationConfig.concat(excuteRecipients),updateArr(excuteInitRecipientsArr,"DELETE"),alertNoticeRelationConfig=alertNoticeRelationConfig.concat(excuteInitRecipientsArr),testParam.alertNoticeRelationConfig=alertNoticeRelationConfig,ajaxService.AjaxPost(testParam,"systemmanager/alertmanager/alertNoticeEdit.do").then(function(result){result&&result.status===1&&(modalService.info({content:"保存成功！",type:"ok"}),ajaxService.AjaxPost({sessionId:sessionId},"systemmanager/alertmanager/getNoticeEmpList.do").then(function(result){result&&result.status===1&&($scope.recipients=result.data,initRecipients=angular.copy($scope.recipients))}))})},$scope.alertType={1:"业务预警",2:"订单预警",3:"短信预警"},$scope.conditions={ajaxUrl:"systemmanager/alertlog/list.do",request:{sessionId:sessionId,pageNo:"1",pageCount:appConstant.pageSet.numPerPage},filter:[{type:"normal",field:"预警类型：",requestFiled:"alertType",value:[{name:"全部",state:!0,value:null},{name:"交易预警",state:!1,value:1},{name:"订单预警",state:!1,value:2},{name:"短信预警",state:!1,value:3}]},{type:"normal",field:"状态：",requestFiled:"statusType",value:[{name:"全部",state:!0,value:null},{name:"未忽略",state:!1,value:"1"},{name:"已忽略",state:!1,value:"0"}]},{type:"dateFlex",field:"选择时间：",value:[{name:"全部",state:!0,value:null},{name:"今天",state:!1,value:0},{name:"昨天",state:!1,value:1},{name:"近7天",state:!1,value:7}],requestFiled:["tradeTime","startDate","endDate"]}],select:{requestFiled:"searchType",options:[{name:"卡号",state:!1,value:3}]},search:{requestFiled:"searchTypeValue",request:{sessionId:sessionId}}},$scope.pageSet={title:"预警记录",currentPage:appConstant.pageSet.currentPage,maxSize:appConstant.pageSet.maxSize,numPerPage:appConstant.pageSet.numPerPage},$scope.selected=[],$scope.checkAll=!1,$scope.checked=!1,$scope.selectAllRecords=function(checkall,datas){if(checkall===!0){$scope.checked=!0,$scope.selected=[];for(var i=0;i<datas.length;i++)$scope.selected.push(datas[i])}else $scope.checked=!1,$scope.selected=[]};var updateSelected=function(action,data){action=="add"&&$scope.selected.indexOf(data)===-1&&$scope.selected.push(data);if(action=="remove"&&$scope.selected.indexOf(data)!==-1){var idx=$scope.selected.indexOf(data);$scope.selected.splice(idx,1)}$scope.selected.length==0&&($scope.checkAll=!1)};$scope.updateSelection=function($event,data){var checkbox=$event.target,action=checkbox.checked?"add":"remove";updateSelected(action,data)},$scope.isDataSelected=function(id){return $scope.selected.indexOf(id)>=0},$scope.ignoreThisCard=function(){var cardNums=[];if($scope.selected.length===0){modalService.info({title:"提示",content:"请至少选中一个卡！",size:"sm",type:"confirm"});return}for(var i=0;i<$scope.selected.length;i++)$scope.selected[i].cardId&&$scope.selected[i].cardId!==null&&cardNums.indexOf($scope.selected[i].cardId)==-1&&cardNums.push($scope.selected[i].cardId);var testParam={sessionId:sessionId,cardNums:cardNums};ajaxService.AjaxPost(testParam,"systemmanager/alertlog/edit.do").then(function(result){result&&(refreshlogs(),$scope.selected=[])})},$scope.ignoreLog=function(){var ids=[];for(var i=0;i<$scope.selected.length;i++)ids.indexOf($scope.selected[i].id)==-1&&ids.push($scope.selected[i].id);if(ids.length==0){modalService.info({title:"提示",content:"请选择预警记录！",size:"sm",type:"confirm"});return}var testParam={sessionId:sessionId,ids:ids};ajaxService.AjaxPost(testParam,"systemmanager/alertlog/edit.do").then(function(result){result&&(refreshlogs(),$scope.selected=[])})},$scope.ignoreThisLog=function(id){var ids=[id],testParam={sessionId:sessionId,ids:ids};ajaxService.AjaxPost(testParam,"systemmanager/alertlog/edit.do").then(function(result){result&&(refreshlogs(),$scope.selected=[])})},$scope.allIgnore=function(){var testParam={sessionId:sessionId,flag:0};ajaxService.AjaxPost(testParam,"systemmanager/alertlog/edit.do").then(function(result){result&&(refreshlogs(),$scope.selected=[])})},$scope.goTradeDetail=function(tsid){register.openTabWithRequest({id:10015},{searchType:3,searchTypeValue:tsid})}}]),"alertManageCtrl"});