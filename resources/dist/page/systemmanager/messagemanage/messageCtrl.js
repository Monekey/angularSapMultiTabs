define(["require","css!score_rule_css","css!message_manage_css","angular","ngAMD"],function(require){var score_rule_css=require("css!score_rule_css"),message_manage_css=require("css!message_manage_css"),angular=require("angular"),ngAMD=require("ngAMD");return ngAMD.controller("messageCtrl",["$scope","$rootScope","ajaxService","modalService","register",function($scope,$rootScope,ajaxService,modalService,register){function loadData(){ajaxService.AjaxPost({sessionId:sessionId},"memberequity/cardtype/getCardTypeCombo.do").then(function(result){result&&($scope.cards=result.data,cardAll=selectAll($scope.cards))}),ajaxService.AjaxPost({sessionId:sessionId},"systemmanager/smsmanager/load.do").then(function(result){if(result){result.data.sysSMSBirthday&&result.data.sysSMSBirthday!==null?($scope.sysSMSBirthday=result.data.sysSMSBirthday,$scope.initSysSMSBirthday=angular.copy($scope.sysSMSBirthday)):($scope.sysSMSBirthday={status:0,day:7,memberTemplate:"尊敬的会员，在您生日到来之际，【集团简称】祝您生日快乐，非常期待您的光临哦！",relativesTemplate:"尊敬的会员，您的【亲友名称】生日即将到来，祝生日快乐!【集团简称】非常期待您的光临哦！"},$scope.initSysSMSBirthday={status:0,day:7,memberTemplate:"尊敬的会员，在您生日到来之际，【集团简称】祝您生日快乐，非常期待您的光临哦！",relativesTemplate:"尊敬的会员，您的【亲友名称】生日即将到来，祝生日快乐!【集团简称】非常期待您的光临哦！"});if(result.data.sysSMSBusiness&&result.data.sysSMSBusiness.length>0)$scope.sysSMSBusiness=result.data.sysSMSBusiness,$scope.initSysSMSBusiness=splitBusiness($scope.sysSMSBusiness);else{var sysSMSBusines={sellCardFlg:1,consumeAmountFlg:1,consumeTimesFlg:1,savingAmountFlg:1,savingTimesFlg:1,reportLossFlg:1,modifyPasswordFlg:1,resetPasswordFlg:1,addIntegralFlg:1,exchangeFlg:1,cardUpgradeFlg:1,cancelFlg:1,cardTypeName:cardAll.cardTypeName?cardAll.cardTypeName:"",typeIds:cardAll.typeIds?cardAll.typeIds:[]};$scope.sysSMSBusiness=[sysSMSBusines],$scope.initSysSMSBusiness=[]}}})}function selectAll(cards){var cardSelect={};cardSelect.typeIds=[],cardSelect.cardTypeName="";for(var i=0;i<cards.length;i++)cardSelect.cardTypeName===""?cardSelect.cardTypeName=cards[i].showName:cardSelect.cardTypeName&&cardSelect.cardTypeName.indexOf(cards[i].showName)===-1&&(cardSelect.cardTypeName=cardSelect.cardTypeName+","+cards[i].showName),cardSelect.typeIds.push(cards[i].value);return cardSelect}function splitBusiness(arr){var newArr=[];if(arr&&arr.length>0)for(var i=0;i<arr.length;i++)if(arr[i].typeIds&&arr[i].typeIds.length>0)for(var j=0;j<arr[i].typeIds.length;j++){var newBusines={sellCardFlg:arr[i].sellCardFlg,consumeAmountFlg:arr[i].consumeAmountFlg,consumeTimesFlg:arr[i].consumeTimesFlg,savingAmountFlg:arr[i].savingAmountFlg,savingTimesFlg:arr[i].savingTimesFlg,reportLossFlg:arr[i].reportLossFlg,modifyPasswordFlg:arr[i].modifyPasswordFlg,resetPasswordFlg:arr[i].resetPasswordFlg,addIntegralFlg:arr[i].addIntegralFlg,exchangeFlg:arr[i].exchangeFlg,cardUpgradeFlg:arr[i].cardUpgradeFlg,cancelFlg:arr[i].cancelFlg};if(arr[i].id){var id=arr[i].id;newBusines.id=id}else newBusines.groupId="new"+i;newBusines.cardTypeId=arr[i].typeIds[j],newArr.push(newBusines),newBusines={}}return newArr}function checkArray(arr,item){for(var i=0;i<arr.length;i++)if(arr[i]&&arr[i].showName===item.showName)return i;return-1}function inArray(arr,item){for(var i=0;i<arr.length;i++)if(arr[i].cardTypeId&&arr[i].cardTypeId===item.cardTypeId)return i;return-1}function isChange(item1,item2){return item1.sellCardFlg===item2.sellCardFlg&&item1.consumeAmountFlg===item2.consumeAmountFlg&&item1.consumeTimesFlg===item2.consumeTimesFlg&&item1.savingAmountFlg===item2.savingAmountFlg&&item1.savingTimesFlg===item2.savingTimesFlg&&item1.reportLossFlg===item2.reportLossFlg&&item1.modifyPasswordFlg===item2.modifyPasswordFlg&&item1.addIntegralFlg===item2.addIntegralFlg&&item1.exchangeFlg===item2.exchangeFlg&&item1.cardUpgradeFlg===item2.cardUpgradeFlg&&item1.cancelFlg===item2.cancelFlg&&item1.resetPasswordFlg===item2.resetPasswordFlg?!0:!1}var sessionId=$rootScope.sessionId,cardAll={};$scope.edit=register.getRoot("编辑"),loadData(),$scope.status={open:!1,templateType:0},$scope.checked=!1;var updateSelected=function(action,card,sysSMSBusines){action=="add"&&sysSMSBusines.typeIds.indexOf(card.value)===-1&&(sysSMSBusines.typeIds.push(card.value),sysSMSBusines.cardTypeName?sysSMSBusines.cardTypeName&&sysSMSBusines.cardTypeName.indexOf(card.showName)===-1&&(sysSMSBusines.cardTypeName=sysSMSBusines.cardTypeName+","+card.showName):sysSMSBusines.cardTypeName=card.showName);if(action=="remove"&&sysSMSBusines.typeIds.indexOf(card.value)!==-1){var idx=sysSMSBusines.typeIds.indexOf(card.value);sysSMSBusines.typeIds.splice(idx,1);if(sysSMSBusines.cardTypeName.indexOf(card.showName)!==-1){sysSMSBusines.cardTypeName=sysSMSBusines.cardTypeName.replace(card.showName,"");var cardTypeNamesArr=sysSMSBusines.cardTypeName.split(","),newArr=[];for(var i=0;i<cardTypeNamesArr.length;i++)cardTypeNamesArr[i]!==""&&newArr.push(cardTypeNamesArr[i]);sysSMSBusines.cardTypeName=newArr.join(",")}}};$scope.updateSelection=function($event,card,sysSMSBusines){var checkbox=$event.target,action=checkbox.checked?"add":"remove";if(action==="add")for(var i=0;i<$scope.sysSMSBusiness.length;i++)for(var j=0;j<$scope.sysSMSBusiness[i].typeIds.length;j++)if(card.value===$scope.sysSMSBusiness[i].typeIds[j]){checkbox.checked=!1,modalService.info({title:"提示",content:"该卡型已被设置，请选择其他卡型！",size:"sm",type:"confirm"});return}updateSelected(action,card,sysSMSBusines)},$scope.isCardSelected=function(id,sysSMSBusines){return sysSMSBusines.typeIds.indexOf(id)>=0},$scope.addRow=function(){var tempArr=[],abledCard={};for(var i=0;i<$scope.sysSMSBusiness.length;i++)for(var j=0;j<$scope.sysSMSBusiness[i].typeIds.length;j++)tempArr.indexOf($scope.sysSMSBusiness[i].typeIds[j])==-1&&tempArr.push($scope.sysSMSBusiness[i].typeIds[j]);var tempCard=angular.copy($scope.cards);for(var j=0;j<$scope.cards.length;j++){var isExist=!1;for(var k=0;k<tempArr.length;k++)$scope.cards[j].value===tempArr[k]&&(isExist=!0);if(isExist){var index=checkArray(tempCard,$scope.cards[j]);tempCard.splice(index,1)}}abledCard=selectAll(tempCard);var sysSMSBusines={sellCardFlg:1,consumeAmountFlg:1,consumeTimesFlg:1,savingAmountFlg:1,savingTimesFlg:1,reportLossFlg:1,modifyPasswordFlg:1,resetPasswordFlg:1,addIntegralFlg:1,exchangeFlg:1,cardUpgradeFlg:1,cancelFlg:1,cardTypeName:abledCard.cardTypeName,typeIds:abledCard.typeIds};$scope.sysSMSBusiness.push(sysSMSBusines)},$scope.minusRow=function(index){$scope.sysSMSBusiness.splice(index,1)},$scope.saveSysSMSBusiness=function(){var addSMSBusiness=[],updateSMSBusiness=[],deleteSMSBusiness=[],currentBusiness=splitBusiness($scope.sysSMSBusiness);if(!currentBusiness||currentBusiness.length===0&&$scope.initSysSMSBusiness&&$scope.initSysSMSBusiness.length>0)for(var j=0;j<$scope.initSysSMSBusiness.length;j++)deleteSMSBusiness.push($scope.initSysSMSBusiness[j]);else if(currentBusiness&&currentBusiness.length>0&&!$scope.initSysSMSBusiness||$scope.initSysSMSBusiness.length===0)for(var i=0;i<currentBusiness.length;i++)addSMSBusiness.push(currentBusiness[i]);else{for(var i=0;i<currentBusiness.length;i++)if(!currentBusiness[i].id)addSMSBusiness.push(currentBusiness[i]);else{var index=inArray($scope.initSysSMSBusiness,currentBusiness[i]);index!==-1?isChange(currentBusiness[i],$scope.initSysSMSBusiness[index])===!1&&updateSMSBusiness.push(currentBusiness[i]):addSMSBusiness.push(currentBusiness[i])}for(var j=0;j<$scope.initSysSMSBusiness.length;j++){var seat=inArray(currentBusiness,$scope.initSysSMSBusiness[j]);seat===-1&&deleteSMSBusiness.push($scope.initSysSMSBusiness[j])}}var param={sessionId:sessionId,addSMSBusiness:addSMSBusiness,updateSMSBusiness:updateSMSBusiness,deleteSMSBusiness:deleteSMSBusiness};ajaxService.AjaxPost(param,"systemmanager/smsmanager/edit.do").then(function(result){result&&result.status===1&&(modalService.info({content:"添加成功!",type:"ok"}),ajaxService.AjaxPost({sessionId:sessionId},"systemmanager/smsmanager/load.do").then(function(result){if(result)if(result.data.sysSMSBusiness&&result.data.sysSMSBusiness.length>0)$scope.sysSMSBusiness=result.data.sysSMSBusiness,$scope.initSysSMSBusiness=splitBusiness($scope.sysSMSBusiness);else{var sysSMSBusines={sellCardFlg:1,consumeAmountFlg:1,consumeTimesFlg:1,savingAmountFlg:1,savingTimesFlg:1,reportLossFlg:1,modifyPasswordFlg:1,resetPasswordFlg:1,addIntegralFlg:1,exchangeFlg:1,cardUpgradeFlg:1,cancelFlg:1,cardTypeName:cardAll.cardTypeName?cardAll.cardTypeName:"",typeIds:cardAll.typeIds?cardAll.typeIds:[]};$scope.sysSMSBusiness=[sysSMSBusines],$scope.initSysSMSBusiness=[]}}))})},$scope.saveSysSMSBirthday=function(){$scope.sysSMSBirthday.id?$scope.sysSMSBirthday!==$scope.initSysSMSBirthday&&($scope.sysSMSBirthday.type=2):$scope.sysSMSBirthday.type=1;var param={sessionId:sessionId,smsBirthday:$scope.sysSMSBirthday};ajaxService.AjaxPost(param,"systemmanager/smsmanager/edit.do").then(function(result){result&&result.status===1&&(modalService.info({title:"提示",content:"保存成功!",size:"sm",type:"ok"}),ajaxService.AjaxPost({sessionId:sessionId},"systemmanager/smsmanager/load.do").then(function(result){result&&result.data.sysSMSBirthday&&($scope.sysSMSBirthday=result.data.sysSMSBirthday,$scope.initSysSMSBirthday=angular.copy($scope.sysSMSBirthday))}))})}}]),"messageCtrl"});